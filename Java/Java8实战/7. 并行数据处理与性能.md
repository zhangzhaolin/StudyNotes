# ç¬¬ä¸ƒç«  å¹¶è¡Œæ•°æ®å¤„ç†ä¸æ€§èƒ½

[TOC]

## å¹¶è¡Œæµ

<u>å¹¶è¡Œæµ</u>å°±æ˜¯ä¸€ä¸ªæŠŠå†…å®¹åˆ†æˆå¤šä¸ªæ•°æ®å—ï¼Œå¹¶ç”¨ä¸åŒçš„çº¿ç¨‹åˆ†åˆ«å¤„ç†å¤šä¸ªæ•°æ®å—çš„æµã€‚

å‡è®¾ä½ éœ€è¦å†™ä¸€ä¸ªæ–¹æ³•ï¼Œæ¥æ”¶æ•°å­—`n`ä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä»1åˆ°ç»™å®šå‚æ•°çš„æ‰€æœ‰æ•°å­—çš„å’Œã€‚ä¸€ä¸ªç›´æ¥çš„æ–¹æ³•æ˜¯ç”Ÿæˆä¸€ä¸ªæ— é™å¤§çš„æµï¼š

```java
public static long sequentialSum(long n) {
    return Stream.iterate(1L,i->i+1)
        limit(n).reduce(0L,Long::sum);
}
```

### å°†é¡ºåºæµè½¬æ¢ä¸ºå¹¶è¡Œæµ

å¯¹é¡ºåºæµå¯ä»¥ä½¿ç”¨`parallel()`å¯ä»¥æŠŠé¡ºåºæµè½¬æ¢ä¸ºå¹¶è¡Œæµï¼š

```java
public static long parallelSum(long n){
    return Stream.iterate(1L,i->i+1)
        		.limit(n)
        		.parallel()			// å°†é¡ºåºæµè½¬æ¢ä¸ºå¹¶è¡Œæµ
        		.reduce(0L,Long::sum);
}
```

![](https://zhangzhaolin.oss-cn-beijing.aliyuncs.com/TIM%E6%88%AA%E5%9B%BE20190306145606.png)

ğŸ”º **å¯¹é¡ºåºæµè°ƒç”¨`parallel`æ–¹æ³•å¹¶ä¸æ„å‘³ç€æµæœ¬èº«æœ‰ä»»ä½•å®é™…çš„å˜åŒ–ã€‚å®ƒåœ¨å†…éƒ¨å®é™…ä¸Šå°±æ˜¯è®¾ç½®äº†ä¸€ä¸ª`boolean`æ ‡å¿—ï¼Œè¡¨ç¤ºä½ æƒ³è®©è°ƒç”¨`parallel`ä¹‹åè¿›è¡Œçš„æ‰€æœ‰æ“ä½œéƒ½å¹¶è¡Œæ‰§è¡Œ**

ç±»ä¼¼çš„ï¼Œ**å¯¹å¹¶è¡Œæµä½¿ç”¨`sequential`æ–¹æ³•å°±å¯ä»¥æŠŠå®ƒå˜æˆé¡ºåºæµ**ï¼Œä¾‹å¦‚ä½ å¯ä»¥è¿™æ ·åš ï¼š

```java
stream.parallel().filter(...)
    .sequential()
    .map(...)
    .parallel()
    .reduce(...);
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæµæ°´çº¿ä¼šå¹¶è¡Œæ‰§è¡Œã€‚

### æµ‹é‡æµæ€§èƒ½

æµ‹é‡å¯¹å‰`n`ä¸ªè‡ªç„¶æ•°æ±‚å’Œçš„å‡½æ•° ï¼š

```java
private static long measureSumPerf(Function<Long, Long> function, long n) {
    long fastest = Long.MAX_VALUE;
    for (int i = 0;i<20;i++){
        long start = System.nanoTime();
        function.apply(n);
        long duration = (System.nanoTime() - start) / 1_000_000;
        if (duration < fastest) fastest = duration;
    }
    return fastest;
}
```

æµ‹è¯•æ±‚å’Œå‡½æ•°æ€§èƒ½ ï¼š

```java
System.out.println("sequentialSum : " + measureSumPerf(ParallelStream::sequentialSum));
System.out.println("parallelSum : " + measureSumPerf(ParallelStream::parallelSum));
```

æˆ‘ä»¬æ‰“å°ä¹‹åå‘ç°ï¼Œæ±‚å’Œæ–¹æ³•çš„å¹¶è¡Œç‰ˆæœ¬è¦æ¯”é¡ºåºæ‰§è¡Œç‰ˆæœ¬æ…¢å¾—å¤šï¼Œè¿™é‡Œå®é™…ä¸Šæœ‰ä¸¤ä¸ªé—®é¢˜ ï¼š

- `iterate`ç”Ÿæˆçš„æ˜¯è£…ç®±å¯¹è±¡ï¼Œå¿…é¡»æ‹†ç®±æˆæ•°å­—æ‰èƒ½æ±‚å’Œ
- æˆ‘ä»¬å¾ˆéš¾æŠŠ`iterate`åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„å—æ¥å¹¶è¡Œæ‰§è¡Œ

`iterate`å¾ˆéš¾åˆ†å‰²æˆèƒ½å¤Ÿç‹¬ç«‹æ‰§è¡Œçš„å°å—ï¼Œå› ä¸ºæ¯æ¬¡åº”ç”¨è¿™ä¸ªå‡½æ•°éƒ½è¦ä¾é å‰ä¸€æ¬¡åº”ç”¨çš„ç»“æœ ï¼š

![](https://zhangzhaolin.oss-cn-beijing.aliyuncs.com/2019-3-6/20190306153731.png)

### ä½¿ç”¨æ›´ä¸ºæœ‰æ•ˆçš„æ–¹æ³•

`LongStream.rangeClosed`æ–¹æ³•ä¸`iterate`ç›¸å¯¹æ¯”æœ‰ä¸¤ä¸ªä¼˜ç‚¹ ï¼š

- `LongStream.rangeClosed`ç›´æ¥äº§ç”ŸåŸå§‹ç±»å‹çš„`long`ï¼Œæ²¡æœ‰è£…ç®±æ‹†ç®±çš„å¼€é”€
- `LongStream.rangeClosed`ä¼šäº§ç”Ÿæ•°å€¼èŒƒå›´ï¼Œå¾ˆå®¹æ˜“æ‹†åˆ†ä¸ºç‹¬ç«‹çš„å°å—ã€‚

ç”¨äºé¡ºåºæµä¸Šçš„æ€§èƒ½ ï¼š

```java
private static long sequentialSum(long n) {
    return LongStream.rangeClosed(1, n)
            .limit(n)
            .reduce(0L, Long::sum);
}
```

```java
System.out.println
("æµæ–¹æ³• ï¼š" + measureSumPerf(ParallelStream::sequentialSum, 10_000_000));
```

ç»“æœä¸º ï¼š

> æµæ–¹æ³• ï¼š22

å¹¶è¡Œæµä¸Šçš„æ€§èƒ½ ï¼š

```java
private static long parallelSum(long n) {
    return LongStream.rangeClosed(1, n)
            .parallel()
            .limit(n)
            .reduce(0L, Long::sum);
}
```

```java
System.out.println
("å¹¶è¡Œæµæ–¹æ³• ï¼š" + measureSumPerf(ParallelStream::parallelSum, 10_000_000));
```

ç»“æœä¸º ï¼š

> å¹¶è¡Œæµæ–¹æ³• ï¼š 1

### ğŸ‚ é«˜æ•ˆä½¿ç”¨å¹¶è¡Œæµ

- å¦‚æœæœ‰ç–‘é—®ï¼Œæµ‹é‡ã€‚åœ¨è€ƒè™‘é€‰æ‹©é¡ºåºæµè¿˜æ˜¯å¹¶è¡Œæµæ—¶ï¼Œç¬¬ä¸€ä¸ªä¹Ÿæ˜¯æœ€é‡è¦çš„å»ºè®®å°±æ˜¯ç”¨é€‚å½“çš„åŸºå‡†æ¥æ£€æŸ¥å…¶æ€§èƒ½ã€‚
- ç•™æ„è£…ç®±ã€‚è‡ªåŠ¨è£…ç®±å’Œæ‹†ç®±ä¼šå¤§å¤§é™ä½æ€§èƒ½ã€‚Java8ä¸­æœ‰<u>åŸå§‹ç±»å‹æµ</u>ï¼ˆ`IntStream`ã€`LongStream`ã€`DoubleStream`ï¼‰æ¥é¿å…è¿™ç§æ“ä½œã€‚
- æœ‰äº›æ“ä½œæœ¬èº«åœ¨å¹¶è¡Œæµä¸Šçš„æ€§èƒ½å°±æ¯”é¡ºåºæµå·®ã€‚ç‰¹åˆ«æ˜¯`limit`å’Œ`findFirst`ç­‰**ä¾èµ–äºå…ƒç´ é¡ºåºçš„æ“ä½œ**ï¼Œä»–ä»¬åœ¨å¹¶è¡Œæµä¸Šæ‰§è¡Œçš„ä»£ä»·éå¸¸å¤§ã€‚ä¾‹å¦‚ï¼Œ`findAny`è¦æ¯”`findFirst`æ€§èƒ½å¥½ï¼Œå› ä¸º`findAny`ä¸æŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œã€‚**è°ƒç”¨`unordered`æ–¹æ³•å¯ä»¥å°†æœ‰åºæµè½¬æ¢ä¸ºæ— åºæµ**ï¼Œå¯¹æ— åºæµè°ƒç”¨`limit`æ–¹æ³•å¯èƒ½ä¼šæ¯”å•ä¸ªæœ‰åºæµæ›´é«˜æ•ˆã€‚
- å¯¹äºè¾ƒå°çš„æ•°æ®é‡ï¼Œé€‰æ‹©å¹¶è¡Œæµå‡ ä¹ä»æ¥éƒ½ä¸æ˜¯ä¸€ä¸ªå¥½çš„å†³å®š
- éœ€è¦è€ƒè™‘æµèƒŒåçš„æ•°æ®ç»“æ„æ˜¯å¦æ˜“äºåˆ†è§£ã€‚ä¾‹å¦‚ï¼Œ`ArrayList`çš„æ‹†åˆ†æ•ˆç‡æ¯”`LinkedList`é«˜å¾ˆå¤šï¼Œå› ä¸ºå‰è€…ä¸éœ€è¦éå†å°±å¯ä»¥å¹³å‡æ‹†åˆ†ï¼Œè€Œåè€…å¿…é¡»è¦éå†ã€‚
- **æµè‡ªèº«çš„ç‰¹ç‚¹ã€ä»¥åŠæµæ°´çº¿çš„ä¸­é—´æ“ä½œä¿®æ”¹æµçš„æ–¹å¼ï¼Œéƒ½å¯èƒ½ä¼šæ”¹å˜åˆ†è§£è¿‡ç¨‹çš„æ€§èƒ½ã€‚**ä¾‹å¦‚ï¼Œä¸€ä¸ª`SIZED`æµï¼ˆè¯¥`Spliterator`ç”±ä¸€ä¸ªå·²çŸ¥å¤§å°çš„æºå»ºç«‹ï¼ˆä¾‹å¦‚Setï¼‰ï¼Œå› æ­¤`estimatedSize()`è¿”å›çš„æ˜¯å‡†ç¡®å€¼ï¼‰å¯ä»¥åˆ†æˆå¤§å°ç›¸ç­‰çš„ä¸¤ä¸ªéƒ¨åˆ†ï¼Œè¿™æ ·æ¯ä¸€éƒ¨åˆ†éƒ½å¯ä»¥æ¯”è¾ƒé«˜æ•ˆçš„å¹¶è¡Œå¤„ç†ï¼Œä½†æ˜¯ç­›é€‰æ“ä½œå¯èƒ½ä¸¢å¼ƒçš„å…ƒç´ ä¸ªæ•°æ— æ³•é¢„æµ‹ï¼Œå¯¼è‡´æµæœ¬èº«å¤§å°æœªçŸ¥ã€‚
- è€ƒè™‘ç»ˆç«¯æ“ä½œä¸­åˆå¹¶æ­¥éª¤çš„ä»£ä»·æ˜¯å¤§æ˜¯å°ï¼ˆä¾‹å¦‚`Collector`ä¸­çš„`combiner`æ–¹æ³•ï¼‰ã€‚å¦‚æœè¿™ä¸€æ­¥ä»£ä»·å¾ˆå¤§ï¼Œé‚£ä¹ˆç»„åˆæ¯ä¸ªå­æµäº§ç”Ÿçš„éƒ¨åˆ†ç»“æœæ‰€ä»˜å‡ºçš„ä»£ä»·å°±å¯èƒ½è¶…è¿‡å¹¶è¡Œæµå¾—åˆ°çš„æ€§èƒ½æå‡ã€‚

|         æº          | å¯åˆ†è§£æ€§ |
| :-----------------: | :------: |
|     `ArrayList`     |   æä½³   |
|    `LinkedList`     |    å·®    |
| `IntStream.range()` |   æä½³   |
|  `Stream.iterate`   |    å·®    |
|      `HashSet`      |    å¥½    |
|      `TreeSet`      |    å¥½    |

## åˆ†æ”¯/åˆå¹¶æ¡†æ¶

åˆ†æ”¯/åˆå¹¶æ¡†æ¶ä½¿ç”¨çš„ç›®çš„å°±æ˜¯<u>ä»¥é€’å½’çš„æ–¹å¼å°†å¯ä»¥å¹¶è¡Œçš„ä»»åŠ¡æ‹†åˆ†æˆä¸ºæ›´å°çš„ä»»åŠ¡ï¼Œç„¶åå°†æ¯ä¸€ä¸ªå­ä»»åŠ¡çš„ç»“æœåˆå¹¶èµ·æ¥å½¢æˆæ•´ä½“ç»“æœ</u>ã€‚å®ƒæ˜¯`ExecutorService`æ¥å£çš„ä¸€ä¸ªå®ç°ï¼Œå®ƒæŠŠå­ä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹æ± ï¼ˆç§°ä¹‹ä¸º`ForkJoinPool`ï¼‰ä¸­çš„å·¥ä½œçº¿ç¨‹ã€‚

### ä½¿ç”¨`RecursiveTask`

è¦æŠŠä»»åŠ¡æäº¤åˆ°`ForkJoinPool`çº¿ç¨‹æ± ï¼Œå¿…é¡»è¦åˆ›å»ºä¸€ä¸ª`RecursiveTask<R>`çš„å­ç±»ï¼Œå…¶ä¸­`R`æ˜¯å¹¶è¡ŒåŒ–ä»»åŠ¡ï¼ˆä»¥åŠæ‰€æœ‰å­ä»»åŠ¡ï¼‰äº§ç”Ÿçš„ç»“æœç±»å‹ï¼Œæˆ–è€…å¦‚æœä»»åŠ¡ä¸è¿”å›ç»“æœï¼Œåˆ™æ˜¯åˆ›å»ºä¸€ä¸ª`RecursiveAction`çš„å­ç±»ã€‚

è¦å®šä¹‰`RecursiveTask`ï¼Œåªéœ€è¦å®ç°å®ƒå”¯ä¸€çš„æŠ½è±¡æ–¹æ³•`compute`ï¼š

```java
protected abstract V compute();
```

è¿™ä¸ªæ–¹æ³•åŒæ—¶å®šä¹‰äº†å°†ä»»åŠ¡æ‹†åˆ†æˆå­ä»»åŠ¡çš„lé€»è¾‘ï¼Œä»¥åŠæ— æ³•å†æ‹†åˆ†æˆ–è€…ä¸æ–¹ä¾¿æ‹†åˆ†æ—¶ï¼Œç”Ÿæˆå•ä¸ªå­ä»»åŠ¡ç»“æœçš„é€»è¾‘ã€‚

```
if(ä»»åŠ¡è¶³å¤Ÿå°æˆ–è€…ä¸å¯åˆ†){
    é¡ºåºè®¡ç®—è¯¥ä»»åŠ¡
}else{
    å°†ä»»åŠ¡åˆ†æˆä¸¤ä¸ªå­ä»»åŠ¡
    é€’å½’è°ƒç”¨æœ¬æ–¹æ³•ï¼Œæ‹†åˆ†æ¯ä¸€ä¸ªå­ä»»åŠ¡ï¼Œç­‰å¾…æ‰€æœ‰å­ä»»åŠ¡å®Œæˆ
    åˆå¹¶æ¯ä¸€ä¸ªå­ä»»åŠ¡çš„ç»“æœ
}
```

é€’å½’çš„ä»»åŠ¡æ‹†åˆ†è¿‡ç¨‹å¦‚å›¾æ‰€ç¤º ï¼š

![](https://zhangzhaolin.oss-cn-beijing.aliyuncs.com/2019-3-6/20190306173419.png)

ä½¿ç”¨åˆ†æ”¯/åˆå¹¶æ¡†æ¶æ‰§è¡Œå¹¶è¡Œæ±‚å’Œ ï¼š

```java
import java.util.concurrent.RecursiveTask;

public class ForkJoinSumCalculator extends RecursiveTask<Long> {
	// è¦æ±‚å’Œçš„æ•°ç»„
    private final long[] numbers;
    private final int start;
    private final int end;
	// ä¸å†å°†ä»»åŠ¡åˆ†è§£ä¸ºå­ä»»åŠ¡çš„æ•°ç»„å¤§å°
    private final int THRESHOLD = 10_000;

    public ForkJoinSumCalculator(long[] numbers){
        this(numbers,0,numbers.length);
    }

    private ForkJoinSumCalculator(long[] numbers,int start,int end){
        this.numbers = numbers;
        this.start = start;
        this.end = end;
    }
	// è¦†ç›–RecursiveTaskæŠ½è±¡æ–¹æ³•
    @Override
    protected Long compute() {
        int length = end - start;
        // å¦‚æœå¤§å°å°äºæˆ–è€…ç­‰äºé˜ˆå€¼ï¼Œåˆ™ç›´æ¥è®¡ç®—ç»“æœ
        if (length <= THRESHOLD){
            return computeCalculation();
        }
        ForkJoinSumCalculator leftTask 
            = new ForkJoinSumCalculator(numbers,start,start + length/2);
        ForkJoinSumCalculator rightTask 
            = new ForkJoinSumCalculator(numbers,start+length/2,end);
        // åˆ©ç”¨å¦å¤–ä¸€ä¸ªForkJoinPoolçº¿ç¨‹å¼‚æ­¥æ‰§è¡Œæ–°åˆ›å»ºçš„å­ä»»åŠ¡
        rightTask.fork();
        // åŒæ­¥æ‰§è¡Œç¬¬äºŒä¸ªå­ä»»åŠ¡ï¼Œæœ‰å¯èƒ½å…è®¸è¿›ä¸€æ­¥é€’å½’åˆ’åˆ†
        long leftResult = leftTask.compute();
        // join() : è¯»å–ç¬¬ä¸€ä¸ªå­ä»»åŠ¡çš„ç»“æœï¼Œå¦‚æœå°šæœªå®Œæˆå°±ç­‰å¾…
        return leftResult + rightTask.join();
    }

    private Long computeCalculation(){
        long sum = 0L;
        for (int i = start;i < end ; i++){
            sum += numbers[i];
        }
        return sum;
    }
}
```

```java
public static long forkJoinSum(long n) {
    long[] numbers = LongStream.rangeClosed(1, n).toArray();
    return new ForkJoinPool().invoke(new ForkJoinSumCalculator(numbers));
}
```

**è¯·æ³¨æ„åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½¿ç”¨å¤šä¸ª`ForkJoinPool`æ˜¯æ²¡æœ‰å®é™…æ„ä¹‰çš„ã€‚å‡ºäºè¿™ä¸ªåŸå› ï¼Œä¸€èˆ¬æ¥è¯´æŠŠå®ƒå®ä¾‹åŒ–ä¸€æ¬¡ï¼Œç„¶åæŠŠå®ä¾‹ä¿å­˜åœ¨é™æ€å­—æ®µä¸­ï¼Œä½¿ä¹‹æˆä¸ºå•ä¾‹ã€‚**

### ä½¿ç”¨åˆ†æ”¯/åˆå¹¶çš„æœ€ä½³åšæ³•

- å¯¹ä¸€ä¸ªä»»åŠ¡è°ƒç”¨`join`æ–¹æ³•ä¼šé˜»å¡è°ƒç”¨æ–¹ï¼Œç›´åˆ°è¯¥ä»»åŠ¡åšå‡ºç»“æœã€‚å› æ­¤ï¼Œæœ‰å¿…è¦åœ¨ä¸¤ä¸ªå­ä»»åŠ¡çš„è®¡ç®—éƒ½å¼€å§‹ä¹‹åå†è°ƒç”¨å®ƒã€‚
- ä¸åº”è¯¥åœ¨`RecursiveTask`å†…éƒ¨è°ƒç”¨`ForkJoinPool`çš„`invoke`æ–¹æ³•ã€‚ç›¸åï¼Œä½ åº”è¯¥å§‹ç»ˆç›´æ¥è°ƒç”¨`compute`æˆ–è€…`fork`æ–¹æ³•ï¼Œåªæœ‰é¡ºåºä»£ç æ‰åº”è¯¥ç”¨`invoke`æ¥å¯åŠ¨å¹¶è®¡ç®—ã€‚
- å¯¹å­ä»»åŠ¡è°ƒç”¨`fork`æ–¹æ³•å¯ä»¥æŠŠå®ƒæ’è¿›`ForkJoinPool`ã€‚åŒæ—¶å¯¹å·¦è¾¹å’Œå³è¾¹å­ä»»åŠ¡åŒæ—¶è°ƒç”¨`fork`ä¼¼ä¹å¾ˆè‡ªç„¶ï¼Œ**ä½†æ˜¯è¿™æ ·åšçš„æ•ˆç‡è¦æ¯”ç›´æ¥å¯¹å…¶ä¸­ä¸€ä¸ªè°ƒç”¨`compute`ä½**ã€‚è¿™æ ·åšä½ å¯ä»¥ä¸ºå…¶ä¸­ä¸€ä¸ªå­ä»»åŠ¡é‡ç”¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œä»è€Œé¿å…åœ¨çº¿ç¨‹æ± ä¸­å¤šåˆ†é…ä¸€ä¸ªä»»åŠ¡é€ æˆçš„å¼€é”€ã€‚
- å’Œå¹¶è¡Œæµä¸€æ ·ï¼Œä½ ä¸åº”è¯¥ç†æ‰€åº”å½“çš„è®¤ä¸ºåœ¨å¤šçº¿ç¨‹å¤„ç†å™¨ä¸Šä½¿ç”¨åˆ†æ”¯/åˆå¹¶æ¡†æ¶å°±æ¯”é¡ºåºè®¡ç®—å¿«ã€‚

### å·¥ä½œçªƒå–

åœ¨å®é™…ä¸­ï¼Œæ¯ä¸€ä¸ªå­ä»»åŠ¡æ‰€èŠ±çš„æ—¶é—´å¯èƒ½å¤©å·®åœ°åˆ«ï¼Œè¦ä¹ˆæ˜¯å› ä¸ºåˆ’åˆ†ç­–ç•¥æ•ˆç‡ä½ï¼Œè¦ä¹ˆæ˜¯æœ‰ä¸å¯çŸ¥çš„åŸå› ã€‚

åˆ†æ”¯/åˆå¹¶æ¡†æ¶ä½¿ç”¨ä¸€ç§è¢«ç§°ä¸º<u>å·¥ä½œçªƒå–</u>çš„æŠ€æœ¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™äº›ä»»åŠ¡è¢«å¹³å‡åˆ†é…åˆ°`ForkJoinPool`ä¸­çš„æ‰€æœ‰çº¿ç¨‹ä¸Šã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ä¸ºåˆ†é…ç»™å®ƒçš„ä»»åŠ¡ä¿å­˜ä¸€ä¸ªåŒé¡¹é“¾å¼é˜Ÿåˆ—ï¼Œæ¯å®Œæˆä¸€ä¸ªä»»åŠ¡ï¼Œå°±ä¼šä»é˜Ÿåˆ—å¤´ä¸Šå–å‡ºä¸‹ä¸€ä¸ªä»»åŠ¡å¼€å§‹æ‰§è¡Œã€‚åŸºäºå‰é¢æ‰€æè¿°çš„åŸå› ï¼ŒæŸä¸€ä¸ªçº¿ç¨‹å¯èƒ½æ—©æ—©çš„å®Œæˆäº†åˆ†é…ç»™å®ƒçš„æ‰€æœ‰ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯å®ƒçš„ä»»åŠ¡å·²ç»ç©ºäº†ï¼Œè€Œå…¶ä»–çš„ä»»åŠ¡è¿˜å¾ˆå¿™ã€‚è¿™æ˜¯ï¼Œè¿™ä¸ªçº¿ç¨‹å¹¶æ²¡æœ‰é—²ä¸‹æ¥ï¼Œè€Œæ˜¯éšæœºé€‰å–äº†ä¸€ä¸ªåˆ«çš„çº¿ç¨‹ï¼Œä»é˜Ÿåˆ—çš„å°¾å·´ä¸Šâ€å·èµ°â€ä¸€ä¸ªä»»åŠ¡ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸€ç›´ç»§ç»­ä¸‹å»ï¼Œç›´åˆ°æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œæ‰€æœ‰çš„é˜Ÿåˆ—éƒ½æ¸…ç©ºã€‚

![](https://zhangzhaolin.oss-cn-beijing.aliyuncs.com/2019-3-13/20190313150735.png)

## `Spliterator`

å’Œ`Iterator`ä¸€æ ·ï¼Œ`Spliterator`ä¹Ÿå¯ä»¥ç”¨äºéå†æ•°æ®æºä¸­çš„å…ƒç´ ï¼Œä½†æ˜¯å®ƒæ˜¯ä¸ºäº†å¹¶è¡Œæ‰§è¡Œè€Œè®¾ç½®çš„ã€‚

```java
public interface Spliterator<T> {
	boolean tryAdvance(Consumer<? super T> action);
    Spliterator<T> trySplit();
    long estimateSize();
    int characteristics();
}
```

`T`æ˜¯`Spliterator`éå†çš„å…ƒç´ ç±»å‹ã€‚

- `tryAdvance`æ–¹æ³•ç±»ä¼¼äºæ™®é€šçš„`Iterator`ï¼Œå› ä¸ºå®ƒä¼šæŒ‰é¡ºåºä¸€ä¸ªä¸ªä½¿ç”¨`Spliterator`ä¸­çš„å…ƒç´ ï¼Œå¦‚æœè¿˜æœ‰å…¶ä»–å…ƒç´ è¦éå†å°±è¿”å›`true`
- `trySplit`æ˜¯ä¸“ä¸º`Spliterator`æ¥å£è®¾è®¡çš„ï¼Œå› ä¸ºå®ƒå¯ä»¥æŠŠä¸€äº›å…ƒç´ åˆ’åˆ†å‡ºå»ç»™ç¬¬äºŒä¸ª`Spliterator`ï¼Œè®©ä»–ä»¬ä¸¤ä¸ªå¹¶è¡Œå¤„ç†
- `estimateSize`æ–¹æ³•ä¼°è®¡è¿˜å‰©ä¸‹å¤šå°‘å…ƒç´ è¦éå†

### æ‹†åˆ†è¿‡ç¨‹

![](https://zhangzhaolin.oss-cn-beijing.aliyuncs.com/2019-3-13/20190313154802.png)

### `Spliterator`ç‰¹æ€§

|     ç‰¹æ€§     |                             å«ä¹‰                             |
| :----------: | :----------------------------------------------------------: |
|  `ORDERED`   | å…ƒç´ æœ‰æ—¢å®šçš„é¡ºåºï¼ˆä¾‹å¦‚`List`ï¼‰ï¼Œå› æ­¤`Spliterator`åœ¨éå†å’Œåˆ’åˆ†æ—¶ä¹Ÿä¼šéµå¾ªè¿™ä¸€é¡ºåº |
|  `DISTINCT`  |    å¯¹äºä»»æ„ä¸€å¯¹éå†è¿‡çš„å…ƒç´ Xå’ŒYï¼Œ`x.equals(y)`è¿”å›`false`    |
|   `SORTED`   |               éå†çš„å…ƒç´ æŒ‰ç…§ä¸€ä¸ªé¢„å®šçš„é¡ºåºæ’åº               |
|   `SIZED`    | è¯¥`Spliterator`ç”±å·²çŸ¥å¤§å°çš„æºå»ºç«‹ï¼ˆä¾‹å¦‚`Set`ï¼‰ï¼Œå› æ­¤`estimatedSize()`è¿”å›çš„æ˜¯å‡†ç¡®å€¼ |
|  `NONNULL`   |                    ä¿è¯éå†çš„å…ƒç´ ä¸ä¸ºNULL                    |
| `IMMUTABLE`  | `Spliterator`çš„æ•°æ®æºä¸èƒ½ä¿®æ”¹ã€‚è¿™æ„å‘³ç€åœ¨éå†æ—¶ä¸èƒ½æ·»åŠ ã€åˆ é™¤æˆ–è€…ä¿®æ”¹ä»»ä½•å…ƒç´  |
| `CONCURRENT` |   è¯¥`Spliterator`çš„æ•°æ®æºå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹åŒæ—¶ä¿®æ”¹è€Œæ— éœ€åŒæ­¥    |
|  `SUBSIZED`  | è¯¥`Spliterator`å’Œæ‰€æœ‰ä»å®ƒæ‹†åˆ†å‡ºæ¥çš„`Spliterator`éƒ½æ˜¯`SIZED`  |

### å®ç°è‡ªå·±çš„`Spliterator`

é¦–å…ˆç”¨ä¸€ä¸ªç®€å•çš„æ–¹æ³•æ¥ç»Ÿè®¡`String`ä¸­å•è¯çš„ä¸ªæ•° ï¼š

```java
private static int countWordsIteratively(String s) {
    int counter = 0;
    // ä¿å­˜ä¸Šä¸€ä¸ªå­—ç¬¦æ˜¯å¦æ˜¯ç©ºæ ¼
    boolean isWhiteSpace = true;
    for (char c : s.toCharArray()){
        if (Character.isWhitespace(c)){
            isWhiteSpace = true;
        }else{
            // å½“ä¸Šä¸€ä¸ªå­—ç¬¦æ˜¯ç©ºæ ¼ è¿™ä¸€ä¸ªå­—ç¬¦ä¸æ˜¯ç©ºæ ¼æ—¶ è®¡æ•°å™¨åŠ ä¸€
            if (isWhiteSpace) counter++;
            isWhiteSpace = false;
        }
    }
    return counter;
}
```

æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªä»£ç  ï¼š

```java
System.out.println(countWordsIteratively(SENTENCE));
```

> 19

### ä»¥å‡½æ•°å¼é£æ ¼é‡å†™å•è¯è®¡æ•°å™¨

é¦–å…ˆï¼Œéœ€è¦å°†`String`è½¬æ¢ä¸ºä¸€ä¸ªæµï¼š

```java
Stream<Character> characterStream = IntStream.range(0,SENTENCE.length()).mapToObj(SENTENCE::charAt);
```

ç°åœ¨ï¼Œä½ å¯ä»¥ç”¨è¿™ä¸ªæµæ¥åšè§„çº¦æ¥è®¡ç®—å­—æ•°ï¼Œä½†æ˜¯ï¼Œåœ¨è§„çº¦æµæ—¶å€™ï¼Œä½ éœ€è¦ä¸¤ä¸ªçŠ¶æ€ï¼šç»Ÿè®¡å­—æ•°ã€ä¸Šä¸€ä¸ªå­—ç¬¦æ˜¯å¦æ˜¯ç©ºæ ¼ã€‚

```java
public class WordCounter {
    private final int counter;
    private final boolean isWhiteSpace;
    public WordCounter(int counter, boolean isWhiteSpace) {
        this.counter = counter;
        this.isWhiteSpace = isWhiteSpace;
    }
    // å’Œè¿­ç®—æ³•ä¸€æ ·ï¼Œaccumulatoræ–¹æ³•ä¸€ä¸ªä¸ªéå†Character
    public WordCounter accumulator(Character character){
        if (Character.isWhitespace(character)){
            return isWhiteSpace ? this : new WordCounter(counter,true);
        }else{
            // ä¸Šä¸€ä¸ªå­—ç¬¦æ˜¯ç©ºæ ¼ï¼Œè¿™ä¸€ä¸ªå­—ç¬¦ä¸æ˜¯ç©ºæ ¼æ—¶ å•è¯è®¡æ•°å™¨åŠ ä¸€
            return isWhiteSpace ? new WordCounter(counter+1,false) : this;
        }
    }
    public WordCounter combiner(WordCounter wordCounter){
        return new WordCounter(counter + wordCounter.counter,false);
    }
    public int getCounter(){
        return counter;
    }
}
```

![](https://zhangzhaolin.oss-cn-beijing.aliyuncs.com/2019-3-13/20190313172347.png)

ç°åœ¨ï¼Œå†™ä¸€ä¸ªæ–¹æ³•è§„çº¦`Character`æµ ï¼š

```java
private static int countWords(Stream<Character> characterStream){
    return characterStream.reduce(new WordCounter(0,true)
            ,WordCounter::accumulator,WordCounter::combiner).getCounter();
}
System.out.println(countWords(characterStream));
```

å¦‚æœå°è¯•ç€å°†ä½¿ç”¨å¹¶è¡ŒæµåŠ å¿«å­—æ•°ç»Ÿè®¡ï¼š

```java
System.out.println(countWords(characterStream.parallel()));
// 27
```

è¿™æ ·ç›´æ¥å¹¶è¡Œæ˜¯ä¸æ­£ç¡®çš„ã€‚å› ä¸ºåŸå§‹çš„`String`åœ¨ä»»æ„ä½ç½®æ‹†åˆ†ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¸€ä¸ªè¯ä¼šå˜æˆä¸¤ä¸ªè¯ï¼Œç„¶åæ•°äº†ä¸¤æ¬¡ã€‚è¿™å°±è¯´æ˜ï¼Œæ‹†åˆ†æµå¯èƒ½ä¼šå½±å“ç»“æœã€‚

è§£å†³æ–¹æ¡ˆå°±æ˜¯è¦ç¡®ä¿Stringä¸æ˜¯åœ¨éšæœºä½ç½®æ‹†åˆ†çš„ï¼Œè€Œåªèƒ½åœ¨è¯å°¾æ‹†å¼€ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½ å¿…é¡»ä¸º`Character`å®ç°ä¸€ä¸ª`Spliterator`ï¼Œå®ƒåªèƒ½åœ¨ä¸¤ä¸ªå•è¯ä¹‹é—´æ‹†åˆ†`String`ï¼š

```java
import java.util.Spliterator;
import java.util.function.Consumer;

public class WordCounterSpliterator implements Spliterator<Character>{

    private final String string;
    private int currentChar;

    public WordCounterSpliterator(String string) {
        this.string = string;
    }

    @Override
    public boolean tryAdvance(Consumer<? super Character> action) {
        // å¤„ç†å½“å‰å­—ç¬¦
        action.accept(string.charAt(currentChar++));
        // å¦‚æœè¿˜æœ‰å­—ç¬¦å¤„ç†ï¼Œåˆ™è¿”å›true
        return currentChar < string.length();
    }

    @Override
    public Spliterator<Character> trySplit() {
        int currentLength = string.length() - currentChar;
        if (currentLength <= 10){
            // è¿”å›nullè¡¨ç¤ºè¦è§£æçš„Stringå·²ç»è¶³å¤Ÿå°ï¼Œå¯ä»¥é¡ºåºå¤„ç†
            return null;
        }
        // å°†è¯•æ¢æ‹†åˆ†ä½ç½® è®¾ç½®åœ¨è¦è§£æçš„Stringçš„ä¸­é—´
        for (int splitPos = currentLength/2 + currentChar;splitPos<string.length();splitPos++){
            // è®©æ‹†åˆ†ä½ç½®å‰è¿›åˆ°ä¸‹ä¸€ä¸ªç©ºæ ¼
            if (Character.isWhitespace(string.charAt(splitPos))){
				// åˆ›å»ºä¸€ä¸ªæ–°çš„Spliteraotræ¥è§£æStringä»å¼€å§‹åˆ°æ‹†åˆ†ä½ç½®çš„éƒ¨åˆ†
                Spliterator<Character> spliterator = new WordCounterSpliterator(string.substring(currentChar,splitPos));
                // å°†è¿™ä¸€ä¸ªSpliteratorçš„å¼€å§‹ä½ç½®è®¾ç½®ä¸ºæ‹†åˆ†ä½ç½®
                currentChar = splitPos;
                return spliterator;
            }
        }
        return null;
    }

    @Override
    public long estimateSize() {
        return string.length() - currentChar;
    }

    @Override
    public int characteristics() {
        return ORDERED + SIZED + IMMUTABLE + NONNULL + SUBSIZED;
    }
}
```

![](https://zhangzhaolin.oss-cn-beijing.aliyuncs.com/2019-3-14/ç»˜å›¾1.jpg)

- `tryAdvance`æ–¹æ³•æŠŠ`String`ä¸­å½“å‰ä½ç½®çš„`Character`ä¼ ç»™äº†`Consumer`ï¼Œå¹¶è®©ä½ç½®åŠ ä¸€ã€‚`Consumer`æ˜¯ä¸€ä¸ªJavaå†…éƒ¨ç±»ï¼Œåœ¨éå†æµæ—¶ï¼Œå°†è¦å¤„ç†çš„`Character`ä¼ ç»™äº†ä¸€ç³»åˆ—è¦å¯¹å…¶æ‰§è¡Œçš„å‡½æ•°ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåªæœ‰ä¸€ä¸ªè§„çº¦å‡½æ•°ï¼Œå³`WordCounter`çš„`accumulate`æ–¹æ³•ã€‚å¦‚æœæ–°çš„æŒ‡é’ˆä½ç½®å°äº`String`æ€»é•¿ï¼Œä¸”è¿˜æœ‰è¦éå†çš„`Character`ï¼Œåˆ™`tryAdvance`è¿”å›`true`
- `trySplit`å®šä¹‰äº†æ‹†åˆ†è¦éå†çš„æ•°æ®ç»“æ„çš„é€»è¾‘ã€‚å°±åƒ`RecursiveTask`ä¸­çš„`compute`æ–¹æ³•ä¸€æ ·ï¼Œ**é¦–å…ˆè¦è®¾å®šä¸€ä¸ªä¸å†ç»§ç»­æ‹†åˆ†çš„ä¸‹é™**ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå°±åƒ`fork-join`é‚£æ ·ï¼Œä½ è‚¯å®šéœ€è¦æ›´é«˜çš„ä¸‹é™æ¥é¿å…ç”Ÿæˆå¤ªå¤šçš„ä»»åŠ¡ã€‚å¦‚æœå‰©ä½™çš„`Character`æ•°é‡ä½äºä¸‹é™ï¼Œä½ å°±è¿”å›`null`è¡¨ç¤ºæ— éœ€è¿›ä¸€æ­¥æ‹†åˆ†ã€‚ç›¸åï¼Œå¦‚æœä½ éœ€è¦æ‰§è¡Œæ‹†åˆ†ï¼Œ**å°±æŠŠè¯•æ¢çš„æ‹†åˆ†ä½ç½®è®¾åœ¨è¦è§£æçš„`String`å—ä¸­é—´ã€‚ä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰ç›´æ¥ä½¿ç”¨è¿™ä¸ªæ‹†åˆ†ä½ç½®ï¼Œå› ä¸ºè¦é¿å…æŠŠè¯åœ¨ä¸­é—´æ–­å¼€**ï¼Œäºæ˜¯ç»§ç»­å¾€å‰æ‰¾ï¼Œ**ä¸€ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªç©ºæ ¼**ã€‚**ä¸€æ—¦æ‰¾åˆ°äº†é€‚å½“çš„æ‹†åˆ†ä½ç½®ï¼Œå°±å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„`Spliterator`æ¥éå†ä»å½“å‰ä½ç½®åˆ°æ‹†åˆ†ä½ç½®çš„å­—ä¸²**ï¼›æŠŠå½“å‰ä½ç½®thisè®¾ç½®ä¸ºæ‹†åˆ†ä½ç½®ï¼Œå› ä¸ºä¹‹å‰çš„éƒ¨åˆ†å°†ç”±æ–°çš„`Spliterator`æ¥å¤„ç†ï¼Œæœ€åè¿”å›ã€‚
- è¿˜éœ€è¦éå†çš„å…ƒç´ çš„é•¿åº¦`estimatedSize`å°±æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²é•¿åº¦å‡å»å½“å‰éå†çš„ä½ç½®å·®
- æœ€åï¼Œ`characteristics`æ–¹æ³•å‘Šè¯‰æ¡†æ¶è¿™ä¸ª`Spliterator`æ˜¯`ORDERED`ï¼ˆé¡ºåºå°±æ˜¯`String`ä¸­å„ä¸ª`Character`çš„æ¬¡åºï¼‰ã€`SIZED`ï¼ˆ`estimatedSize`æ–¹æ³•çš„è¿”å›å€¼æ˜¯ç²¾ç¡®çš„ï¼‰ã€`SUBSIZED`ï¼ˆ`trySplit`æ–¹æ³•åˆ›å»ºçš„å…¶ä»–`Spliterator`ä¹Ÿæœ‰ç¡®åˆ‡çš„å¤§å°ï¼‰ã€`NONNULL`ï¼ˆ`String`ä¸­ä¸èƒ½æœ‰ç©ºçš„`Character`ï¼‰å’Œ`IMMUTABLE`ï¼ˆåœ¨è§£æ`String`æ—¶ä¸èƒ½å†æ·»åŠ `Character`ï¼‰ã€‚

```java
Spliterator<Character> spliterator = new WordCounterSpliterator(SENTENCE);
// ä¼ ç»™StreaSuppot.streamçš„ç¬¬äºŒä¸ªå‚æ•°æ„å‘³ç€ä½ æƒ³åˆ›å»ºä¸€ä¸ªå¹¶è¡Œæµ
Stream<Character> stream = StreamSupport.stream(spliterator, true);
System.out.println(countWords(stream));
```

â„ `Spliterator`å¯ä»¥åœ¨ç¬¬ä¸€æ¬¡éå†ã€ç¬¬ä¸€æ¬¡æ‹†åˆ†æˆ–è€…ç¬¬ä¸€æ¬¡æŸ¥è¯¢ä¼°è®¡å¤§å°æ—¶ç»‘å®šå…ƒç´ çš„æ•°æ®æºï¼Œè€Œä¸æ˜¯åœ¨åˆ›å»ºæ—¶å°±ç»‘å®šã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒè¢«ç§°ä¹‹ä¸º<u>å»¶è¿Ÿç»‘å®šçš„</u>`Spliterator`

## ğŸ¥ å°è®°

- å†…éƒ¨è¿­ä»£è®©ä½ å¯ä»¥å¹¶è¡Œå¤„ç†ä¸€ä¸ªæµï¼Œè€Œæ— éœ€åœ¨ä»£ç ä¸­æ˜¾ç¤ºä½¿ç”¨å’Œåè°ƒä¸åŒçš„çº¿ç¨‹ã€‚
- è™½ç„¶å¹¶è¡Œå¤„ç†ä¸€ä¸ªæµå¾ˆå®¹æ˜“ï¼Œå´ä¸èƒ½ä¿è¯ç¨‹åºåœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½è¿è¡Œå¾—å¾ˆå¿«ã€‚å¹¶è¡Œè½¯ä»¶è¡Œä¸ºå’Œæ€§èƒ½æœ‰æ—¶æ˜¯è¿åç›´è§‰çš„ï¼Œå› æ­¤ä¸€å®šè¦æµ‹é‡ï¼Œç¡®ä¿ä½ æ²¡æœ‰æŠŠç¨‹åºæ‹–å¾—å¾ˆæ…¢ã€‚
- åƒå¹¶è¡Œæµé‚£æ ·å¯¹ä¸€ä¸ªæ•°æ®é›†å¹¶è¡Œæ‰§è¡Œæ“ä½œå¯ä»¥æå‡æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯è¦å¤„ç†çš„å…ƒç´ æ•°é‡åºå¤§ï¼Œæˆ–å¤„ç†å•ä¸ªå…ƒç´ ç‰¹åˆ«è€—æ—¶çš„æ—¶å€™ã€‚
- ä»æ€§èƒ½è§’åº¦ä¸Šçœ‹ï¼Œä½¿ç”¨æ­£ç¡®çš„æ•°æ®ç»“æ„ï¼Œå¦‚å°½å¯èƒ½åˆ©ç”¨åŸå§‹æµè€Œä¸æ˜¯ä¸€èˆ¬åŒ–çš„æµï¼Œå‡ ä¹æ€»æ˜¯æ¯”å°è¯•å¹¶è¡ŒåŒ–æŸäº›æ“ä½œæ›´ä¸ºé‡è¦ã€‚
- åˆ†æ”¯/åˆå¹¶æ¡†æ¶è®©ä½ å¾—ä»¥ç”¨é€’å½’çš„æ–¹å¼å°†å¯ä»¥å¹¶è¡Œçš„ä»»åŠ¡æ‹†åˆ†æˆæ›´å°çš„ä»»åŠ¡ï¼Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œç„¶åå°†å„ä¸ªå­ä»»åŠ¡åˆå¹¶èµ·æ¥ç”Ÿæˆæ•´ä¸ªç»“æœ
- `Spliterator`å®šä¹‰äº†å¹¶è¡Œæµå¦‚ä½•æ‹†åˆ†å®ƒè¦éå†çš„æ•°æ®