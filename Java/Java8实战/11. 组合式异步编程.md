# ç¬¬åä¸€ç«  `CompletableFuture`ï¼šç»„åˆå¼å¼‚æ­¥ç¼–ç¨‹

[TOC]

## 0. å¼•è¨€

ä¾‹å¦‚ï¼Œä½ å¯èƒ½é‡åˆ°è¿‡è¿™ç§éœ€æ±‚ï¼šä¸ºæ³•å›½å®¢æˆ·æä¾›æŒ‡å®šä¸»é¢˜çš„çƒ­é—¨æŠ¥é“ã€‚

ä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œä½ å¯èƒ½éœ€è¦å‘æ–°æµªæˆ–è€…æ¨ç‰¹çš„APIè¯·æ±‚æ‰€æœ‰è¯­è¨€ä¸­é’ˆå¯¹è¯¥ä¸»é¢˜æœ€çƒ­é—¨çš„å†…å®¹ï¼Œä¹‹åå¯èƒ½ä½ éœ€è¦ä¾æ®ä½ çš„å†…éƒ¨ç®—æ³•å¯¹å®ƒä»¬çš„ç›¸å…³æ€§è¿›è¡Œæ’åºï¼›ä¹‹åï¼Œä½ å¯èƒ½éœ€è¦è°·æ­Œç¿»è¯‘å°†ä»–ä»¬ç¿»è¯‘æˆæ³•è¯­ï¼Œç”šè‡³ï¼Œä½ å¯èƒ½éœ€è¦åœ°å›¾æœåŠ¡å®šä½å‡ºè¯„è®ºä½œè€…çš„ä½ç½®ä¿¡æ¯ï¼Œæœ€ç»ˆå°†è¿™äº›ä¿¡æ¯èšé›†èµ·æ¥ï¼Œå‘ˆç°åœ¨ä½ çš„ç½‘ç«™ä¸Šã€‚

å½“ç„¶ï¼Œå¦‚æœæŸäº›å¤–éƒ¨ç½‘ç»œæœåŠ¡å‘ç”Ÿå“åº”æ…¢çš„æƒ…å†µï¼Œä½ ä¾ç„¶å¸Œæœ›èƒ½ä¸ºç”¨æˆ·æä¾›éƒ¨åˆ†ä¿¡æ¯ï¼Œä¾‹å¦‚æä¾›å¸¦é—®å·æ ‡è®°çš„é€šç”¨åœ°å›¾ï¼Œä»¥æ–‡æœ¬çš„æ–¹å¼æ˜¾ç¤ºä¿¡æ¯ï¼Œè€Œä¸æ˜¯å‘†å‘†çš„å±•ç¤ºä¸€ç‰‡ç©ºç™½çš„å±å¹•ï¼Œä¸€ç›´åˆ°åœ°å›¾æœåŠ¡è¿”å›ç»“æœæˆ–è€…è¶…æ—¶ã€‚

![](https://raw.githubusercontent.com/zhangzhaolin/GraphBed/master/20190401/20190401162950.png)

åœ¨ç¬¬ä¸ƒç« ä¸­ä»‹ç»çš„åˆ†æ”¯/åˆå¹¶æ¡†æ¶ä»¥åŠå¹¶è¡Œæµæ˜¯å®ç°å¹¶è¡Œå¤„ç†çš„å·¥å…·ï¼›å®ƒä»¬å°†ä¸€ä¸ªæ“ä½œåˆ‡å‰²æˆå¤šä¸ªæ“ä½œï¼Œåœ¨å¤šä¸ªä¸åŒçš„æ ¸ã€CPUç”šè‡³æ˜¯æœºå™¨ä¸Šå¹¶è¡Œåœ°æ‰§è¡Œè¿™äº›è‡ªæ“ä½œã€‚

ä¸æ­¤ç›¸åï¼Œå¦‚æœä½ æƒ³è¦çš„æ˜¯å®ç°å¹¶å‘ï¼Œè€Œéå¹¶è¡Œï¼Œæˆ–è€…ä½ çš„ç›®çš„æ˜¯åœ¨åŒä¸€ä¸ªCPUä¸Šæ‰§è¡Œå‡ ä¸ªæ¾è€¦åˆçš„ä»»åŠ¡ï¼Œå……åˆ†åˆ©ç”¨CPUçš„æ ¸ï¼Œè®©å…¶è¶³å¤Ÿå¿™ç¢Œï¼Œä»è€Œæœ€å¤§åŒ–ç¨‹åºçš„ååé‡ï¼Œé‚£ä¹ˆä½ çœŸå®æƒ³åšçš„äº‹é¿å…ç­‰å¾…è¿œç¨‹çš„è¿”å›ï¼Œæˆ–è€…å¯¹æ•°æ®åº“çš„æŸ¥è¯¢ï¼Œè€Œé˜»å¡çº¿ç¨‹çš„æ‰§è¡Œï¼Œæµªè´¹å®è´µçš„è®¡ç®—èµ„æºï¼Œå› ä¸ºè¿™ç§ç­‰å¾…çš„æ—¶é—´å¯èƒ½ç›¸å½“é•¿ã€‚

`Future`æ¥å£ï¼Œå°¤å…¶æ˜¯å®ƒçš„å®ç°`CompletableFuture`ï¼Œæ˜¯å¤„ç†è¿™ç§æƒ…å†µçš„åˆ©å™¨ã€‚

![](https://raw.githubusercontent.com/zhangzhaolin/GraphBed/master/20190401/20190401164717.png)

## 1. `Future`æ¥å£

â˜˜ `Future`æ¥å£è®¾è®¡åˆè¡·æ˜¯**å¯¹å°†æ¥æŸä¸€ä¸ªæ—¶åˆ»ä¼šå‘ç”Ÿçš„ç»“æœè¿›è¡Œå»ºæ¨¡ã€‚å®ƒå»ºæ¨¡äº†ä¸€ç§å¼‚æ­¥è¿ç®—ï¼Œè¿”å›ä¸€ä¸ªæ‰§è¡Œè¿ç®—ç»“æœçš„å¼•ç”¨ï¼Œå½“è¿ç®—ç»“æŸåï¼Œè¿™ä¸ªå¼•ç”¨ä¼šè¿”å›ç»™è°ƒç”¨æ–¹ã€‚**åœ¨`Future`ä¸­è§¦å‘é‚£äº›æ½œåœ¨è€—æ—¶çš„æ“ä½œæŠŠè°ƒç”¨çº¿ç¨‹é‡Šæ”¾å‡ºæ¥ï¼Œè®©å®ƒèƒ½ç»§ç»­æ‰§è¡Œæœ‰ä»·å€¼çš„å·¥ä½œï¼Œä¸éœ€è¦å‘†å‘†åœ°ç­‰å¾…è€—æ—¶æ“ä½œçš„å®Œæˆã€‚

```java
public static void main(String[] args) {
    // åˆ›å»ºExecutorServiceï¼Œé€šè¿‡å®ƒä½ å¯ä»¥å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡
    ExecutorService service = Executors.newCachedThreadPool();
    // å‘ExecutorServiceæäº¤ä¸€ä¸ªCallableå¯¹è±¡
    Future<Double> future = service.submit(Main::doSomeLongComputation);
    System.out.println("do some thing else...");
    Double result = null;
    try {
        // è·å–å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œå¦‚æœæœ€ç»ˆè¢«é˜»å¡ï¼Œæ— æ³•å¾—åˆ°ç»“æœï¼Œé‚£ä¹ˆåœ¨æœ€å¤šç­‰å¾…äº”ç§’é’Ÿä¹‹åé€€å‡º
        result = future.get(5, TimeUnit.SECONDS);
    } catch (InterruptedException e) {
        // å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…ä¸­è¢«ä¸­æ–­
        e.printStackTrace();
    } catch (ExecutionException e) {
        // è®¡ç®—æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸
        e.printStackTrace();
    } catch (TimeoutException e) {
        // åœ¨Futureå¯¹è±¡å®Œæˆä¹‹å‰è¶…è¿‡å·²è¿‡æœŸ
        e.printStackTrace();
    }
    System.out.println("result : " + result);
}
private static Double doSomeLongComputation() throws InterruptedException {
    Thread.sleep(3 * 1000);
    return 1d;
}
```

è¿™ç§ç¼–ç¨‹æ–¹å¼**è®©ä½ çš„çº¿ç¨‹å¯ä»¥åœ¨`ExecutorService`ä»¥å¹¶å‘æ–¹å¼è°ƒç”¨å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè€—æ—¶æ“ä½œçš„åŒæ—¶ï¼Œå»æ‰§è¡Œä¸€äº›å…¶ä»–çš„ä»»åŠ¡ã€‚**ç´§æ¥ç€ï¼Œå¦‚æœä½ å·²ç»è¿è¡Œåˆ°æ²¡æœ‰å¼‚æ­¥æ“ä½œçš„ç»“æœå°±æ— æ³•ç»§ç»­ä»»ä½•æœ‰æ„ä¹‰çš„å·¥ä½œæ—¶ï¼Œå¯ä»¥è°ƒç”¨å®ƒçš„`get`æ–¹æ³•å»è·å–æ“ä½œçš„ç»“æœã€‚å¦‚æœæ“ä½œå·²ç»å®Œæˆï¼Œè¯¥æ–¹æ³•ä¼šç«‹åˆ»è¿”å›æ“ä½œçš„ç»“æœï¼Œå¦åˆ™å®ƒä¼šé˜»å¡ä½ çš„çº¿ç¨‹ï¼Œä¸€ç›´åˆ°æ“ä½œå®Œæˆè¿”å›ç›¸åº”çš„ç»“æœã€‚

![](https://raw.githubusercontent.com/zhangzhaolin/GraphBed/master/20190408/20190408154744.png)

### 1.1 `Future`æ¥å£å±€é™æ€§

`Future`ä¸è¶³ä»¥è®©ä½ ç¼–å†™ç®€å•ç®€æ´çš„å¹¶å‘ä»£ç ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¾ˆéš¾è¡¨è¿°`Future`ç»“æœä¹‹é—´çš„ä¾èµ–æ€§ï¼šå½“é•¿æ—¶é—´è®¡ç®—ä»»åŠ¡å®Œæˆæ—¶ï¼Œè¯·å°†è¯¥è®¡ç®—çš„ç»“æœé€šçŸ¥åˆ°å¦ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„è®¡ç®—ä»»åŠ¡ï¼Œè¿™ä¸¤ä¸ªè®¡ç®—ä»»åŠ¡éƒ½å®Œæˆåï¼Œå°†è®¡ç®—çš„ç»“æœå’Œå¦ä¸€ä¸ªæŸ¥è¯¢æ“ä½œç»“æœåˆå¹¶

- å°†ä¸¤ä¸ªå¼‚æ­¥è®¡ç®—åˆå¹¶ä¸ºä¸€ä¸ª â€”â€” è¿™ä¸¤ä¸ªå¼‚æ­¥è®¡ç®—ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼ŒåŒæ—¶ç¬¬äºŒä¸ªåˆä¾èµ–äºç¬¬ä¸€ä¸ªçš„ç»“æœ
- ç­‰å¾…`Future`é›†åˆä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆ
- ä»…ä»…ç­‰å¾…`Future`é›†åˆä¸­æœ€å¿«ç»“æŸçš„ä»»åŠ¡å®Œæˆï¼Œå¹¶è¿”å›å®ƒçš„ç»“æœ
- é€šè¿‡ç¼–ç¨‹æ–¹å¼å®Œæˆä¸€ä¸ª`Future`ä»»åŠ¡çš„æ‰§è¡Œ
- åº”å¯¹`Future`çš„å®Œæˆäº‹ä»¶ï¼ˆå³å½“`Future`çš„å®Œæˆäº‹ä»¶å‘ç”Ÿæ—¶ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œå¹¶èƒ½ä½¿ç”¨`Future`è®¡ç®—çš„ç»“æœè¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œï¼Œä¸åªæ˜¯ç®€å•åœ°é˜»å¡ç­‰å¾…æ“ä½œçš„ç»“æœï¼‰

### 1.2 ä½¿ç”¨`CompletableFuture`æ„å»ºå¼‚æ­¥åº”ç”¨

#### 1.2.1 åŒæ­¥APIä¸å¼‚æ­¥API

**åŒæ­¥API**å…¶å®åªæ˜¯å¯¹ä¼ ç»Ÿæ–¹æ³•è°ƒç”¨çš„å¦å¤–ä¸€ç§ç§°å‘¼ï¼šä½ è°ƒç”¨äº†æŸä¸ªæ–¹æ³•ï¼Œè°ƒç”¨æ–¹åœ¨è¢«è°ƒç”¨æ–¹è¿è¡Œçš„è¿‡ç¨‹ä¸­ä¼šç­‰å¾…ï¼Œè¢«è°ƒç”¨æ–¹è¿è¡Œç»“æŸè¿”å›ï¼Œè°ƒç”¨æ–¹å–å¾—è¢«è°ƒç”¨æ–¹çš„è¿”å›å€¼å¹¶ç»§ç»­è¿è¡Œã€‚

**å¼‚æ­¥API**ä¼šç›´æ¥è¿”å›ï¼Œæˆ–è€…è‡³å°‘åœ¨è¢«è°ƒç”¨æ–¹è®¡ç®—å®Œæˆä¹‹å‰ï¼Œå°†å®ƒå‰©ä½™çš„è®¡ç®—ä»»åŠ¡äº¤ç»™å¦å¤–ä¸€ä¸ªçº¿ç¨‹å»åšï¼Œè¯¥çº¿ç¨‹å’Œè°ƒç”¨æ–¹æ˜¯å¼‚æ­¥çš„ â€”â€” è¿™å°±æ˜¯**éé˜»å¡è°ƒç”¨**çš„ç”±æ¥ã€‚

## 2.  å®ç°å¼‚æ­¥API

ä¸ºäº†å®ç°æœ€ä½³ä»·æ ¼æŸ¥è¯¢å™¨åº”ç”¨ï¼Œé¦–å…ˆï¼Œå•†åº—åº”è¯¥å£°æ˜ä¾æ®åˆ¶å®šçš„äº§å“åç§°è¿”å›ä»·æ ¼çš„æ–¹æ³•ï¼š

```java
// æ¨¡æ‹Ÿä¸€ç§’é’Ÿå»¶è¿Ÿçš„æ–¹æ³•
public static void delay() {
    try {
        Thread.sleep(1 * 1000L);
    } catch (InterruptedException e) {
        throw new RuntimeException(e);
    }
}
```

```java
public class Shop{
    public double getPrice(String product) {
    	return calculatePrice(product);
	}    
    private double calculatePrice(String product) {
        // å¼•å…¥ä¸€ä¸ªæ¨¡æ‹Ÿçš„å»¶è¿Ÿ
        Utils.delay();
        return random.nextDouble() * product.charAt(0) + product.charAt(1);
    }
}
```

### 2.1 å°†åŒæ­¥æ–¹æ³•è½¬æ¢ä¸ºå¼‚æ­¥æ–¹æ³•

ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦å°†`getPrice()`è½¬æ¢ä¸º`getPriceAsync()`ï¼š

```java
public Future<Double> getPriceAsync(String product){...}
```

 `Future`ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥è¿ç®—ï¼ˆå³è°ƒç”¨çº¿ç¨‹å¯ä»¥ç»§ç»­è¿è¡Œï¼Œä¸ä¼šå› ä¸ºè°ƒç”¨æ–¹æ³•è€Œé˜»å¡ï¼‰çš„ç»“æœã€‚è¿™æ„å‘³ç€`Future`æ˜¯ä¸€ä¸ªæš‚æ—¶è¿˜ä¸çŸ¥é“çš„å€¼çš„å¤„ç†å™¨ï¼Œè¿™ä¸ªå€¼åœ¨è®¡ç®—å®Œæˆåï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨å®ƒçš„`get()`æ–¹æ³•å–å¾—ã€‚å› ä¸ºè¿™æ ·çš„è®¾è®¡ï¼Œ`getPriceAsync()`æ–¹æ³•æ‰èƒ½ç«‹åˆ»è¿”å›ï¼Œç»™è°ƒç”¨çº¿ç¨‹ä¸€ä¸ªæœºä¼šï¼Œèƒ½åœ¨åŒä¸€æ—¶é—´å»æ‰§è¡Œå…¶ä»–æœ‰ä»·å€¼çš„ä»»åŠ¡ã€‚

```java
public Future<Double> getPriceAsync(String product) {
    CompletableFuture<Double> completableFuture = new CompletableFuture<>();
    new Thread(() -> {
        // éœ€é•¿æ—¶é—´è®¡ç®—çš„ä»»åŠ¡ç»“æŸå¹¶å¾—å‡ºç»“æœæ—¶ï¼Œè®¾ç½®Futureçš„è¿”å›å€¼
        completableFuture.complete(calculatePrice(product));
    }).start();
    return completableFuture;
}
```

ä½¿ç”¨å¼‚æ­¥APIï¼š

```java
public static void main(String[] args) {
    Shop shop = new Shop("BestShop");
    long start = System.nanoTime();
    Future<Double> futurePrice = shop.getPriceAsync("my favorite product");
    long invocationTime = (System.nanoTime() - start) / 1_000_000;
    System.out.println("Invocation returned time : " + invocationTime + " msecs");
    // æ‰§è¡Œæ›´å¤šä»»åŠ¡ ä¾‹å¦‚æŸ¥è¯¢å…¶ä»–å•†åº—
    System.out.println("æ‰§è¡Œæ›´å¤šä»»åŠ¡ ... ");
    try {
        double price = futurePrice.get();
        System.out.printf("Price is %.2f%n", price);
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
    long retrievalTime = (System.nanoTime() - start) / 1_000_000;
    System.out.println("Price returned after " + retrievalTime + " msecs");
}
/**
	Invocation returned time : 46 msecs
	æ‰§è¡Œæ›´å¤šä»»åŠ¡ ...
	Price is 200.26
	Price returned after 1049 msecs
*/
```

### 2.2 é”™è¯¯å¤„ç†

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå¦‚æœåœ¨è®¡ç®—ä»·æ ¼è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼Œé‚£ä¹ˆä¼šå¾—åˆ°ç³Ÿç³•çš„ç»“æœï¼šç”¨äºæç¤ºé”™è¯¯çš„å¼‚å¸¸ä¼šè¢«é™åˆ¶åœ¨è®¡ç®—å•†å“ä»·æ ¼çš„å½“å‰çº¿ç¨‹èŒƒå›´å†…ï¼Œæœ€ç»ˆä¼šæ€æ­»è¯¥çº¿ç¨‹ï¼Œè¿™ä¼šå¯¼è‡´ç­‰å¾…`get()`æ–¹æ³•è¿”å›ç»“æœçš„å®¢æˆ·ç«¯æ°¸ä¹…çš„é˜»å¡

å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨é‡è½½çš„`get()`æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```java
V get(long timeout, TimeUnit unit)
        throws InterruptedException, ExecutionException, TimeoutException;
```

ä½ å¯ä»¥ä½¿ç”¨`CompletableFuture`ç±»ä¸­çš„`completeExceptionally()`æ–¹æ³•å°† å¯¼è‡´`CompletableFuture`å†…å‘ç”Ÿçš„å¼‚å¸¸æŠ›å‡ºï¼š

```java
public Future<Double> getPriceAsync(String product) {
    CompletableFuture<Double> future = new CompletableFuture<>();
    new Thread(() -> {
        try {
            Double price = calculatePrice(product);
            future.complete(price);
        } catch (Exception e) {
            future.completeExceptionally(e);
        }
    }).start();
    return future;
}
```

å®¢æˆ·ç«¯ç°åœ¨ä¼šæŠ›å‡ºä¸€ä¸ª`ExecutionException`å¼‚å¸¸ï¼ˆè®¡ç®—æ—¶æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œè¯¥å¼‚å¸¸æ¥æ”¶äº†ä¸€ä¸ªåŒ…å«å¤±è´¥åŸå› çš„`Exception`å‚æ•°ã€‚ä¾‹å¦‚ï¼Œè¯¥æ–¹æ³•æŠ›å‡ºäº†ä¸€ä¸ª`product not available`ï¼Œå®¢æˆ·ç«¯ä¼šå¾—åˆ°ä¸‹é¢ä¸€æ®µ`Exception`ï¼š

```java
java.util.concurrent.ExecutionException: java.lang.RuntimeException: product not available
	at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:357)
	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1915)
	at Main.main(Main.java:19)
Caused by: java.lang.RuntimeException: product not available
	at Shop.calculatePrice(Shop.java:34)
	at Shop.lambda$getPriceAsync$0(Shop.java:23)
	at java.lang.Thread.run(Thread.java:748)
```

**ä½¿ç”¨å·¥å‚æ–¹æ³•`supplyAsync`åˆ›å»º`CompletableFuture`**

```java
public Future<Double> getPriceAsync(String product) {
    return CompletableFuture.supplyAsync(() -> calculatePrice(product));
}
```

`supplyAsync`æ–¹æ³•æ¥å—ä¸€ä¸ªç”Ÿäº§è€…æ–¹æ³•ï¼ˆ`Supplier`ï¼‰ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ª`CompletableFuture`å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å®Œæˆå¼‚æ­¥æ“ä½œåä¼šè¯»å–è°ƒç”¨ç”Ÿäº§è¿™æ–¹æ³•çš„è¿”å›å€¼ã€‚ç”Ÿäº§è€…æ–¹æ³•ä¼šäº¤ç”±`ForkJoinPool`æ± ä¸­çš„æŸä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼ˆ`Executor`ï¼‰è¿è¡Œï¼›

ä½†æ˜¯ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨`supplyAsync`æ–¹æ³•çš„é‡è½½ç‰ˆæœ¬ï¼Œä¼ é€’ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šä¸åŒçš„çº¿ç¨‹æ‰§è¡Œç”Ÿäº§è€…æ–¹æ³•ã€‚

```java
public static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier,
                                                   Executor executor)
```

åœ¨è¿™ä¸€ç« å‰©ä½™å†…å®¹ä¸­ï¼Œå‡è®¾æˆ‘ä»¬æ— æ³•æ§åˆ¶`Shop`ç±»æä¾›APIçš„å…·ä½“å®ç°ï¼Œæœ€ç»ˆæä¾›ç»™ä½ çš„APIéƒ½æ˜¯åŒæ­¥é˜»å¡å¼çš„æ–¹æ³•ã€‚æˆ‘ä»¬å°†ä¼šå­¦åˆ°å¦‚ä½•ä»¥å¼‚æ­¥çš„æ–¹å¼æŸ¥è¯¢å¤šä¸ªå•†åº—ï¼Œé¿å…å•ä¸€çš„è¯·æ±‚å µå¡ï¼Œå¹¶ç”±æ­¤æå‡ç¨‹åºæ€§èƒ½å’Œååé‡

## 3. è®©ä»£ç å…æ”¶é˜»å¡ä¹‹è‹¦

ç°åœ¨ï¼Œæˆ‘ä»¬è¢«è¦æ±‚å¼€å‘â€œæœ€ä½³ä»·æ ¼æŸ¥è¯¢å™¨â€çš„åº”ç”¨ï¼Œä½†æ˜¯è¿œç¨‹ç«¯éƒ½åªæä¾›äº†åŒæ­¥APIï¼š

```java
private static List<Shop> shops = Arrays.asList(new Shop("BestPrice"),
        new Shop("LetsSaveBig"),
        new Shop("MyFavoriteShop"),
        new Shop("BuyItAll"));

public static List<String> findPrices(String product) {
    return shops.stream()
            .map(
                    shop -> String.format("%s å•†åº—ä»·æ ¼ä¸º %.2f", shop.getShopName(), shop.getPrice(product))
            )
            .collect(Collectors.toList());
}

public static void main(String[] args) {
    long start = System.nanoTime();
    System.out.println(findPrices("Iphone27s"));
    long duration = (System.nanoTime() - start) / 1_000_000;
    System.out.println("ä»£ç å®Œæˆæ—¶é•¿ : " + duration + " æ¯«ç§’");
}
```

è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```
[BestPrice å•†åº—ä»·æ ¼ä¸º 176.24, LetsSaveBig å•†åº—ä»·æ ¼ä¸º 115.54, MyFavoriteShop å•†åº—ä»·æ ¼ä¸º 178.67, BuyItAll å•†åº—ä»·æ ¼ä¸º 116.05]
ä»£ç å®Œæˆæ—¶é•¿ : 4082 æ¯«ç§’
```

### 3.1 ä½¿ç”¨å¹¶è¡Œæµ

```java
public static List<String> findPrices(String product) {
    return shops.parallelStream()
            .map(
                    shop -> String.format("%s å•†åº—ä»·æ ¼ä¸º %.2f", shop.getShopName(), shop.getPrice(product))
            )
            .collect(Collectors.toList());
}
```

è¿è¡Œç»“æœå¦‚ä¸‹ ï¼š

```
[BestPrice å•†åº—ä»·æ ¼ä¸º 129.67, LetsSaveBig å•†åº—ä»·æ ¼ä¸º 160.50, MyFavoriteShop å•†åº—ä»·æ ¼ä¸º 157.11, BuyItAll å•†åº—ä»·æ ¼ä¸º 142.52]
ä»£ç å®Œæˆæ—¶é•¿ : 1092 æ¯«ç§’
```

### 3.2 ä½¿ç”¨`CompletableFuture`å‘èµ·å¼‚æ­¥è¯·æ±‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å·¥å‚æ–¹æ³•`supplyAsync()`åˆ›å»º`CompletableFuture`å¯¹è±¡ï¼š

```java
List<CompletableFuture<String>> futureList =
        shops.parallelStream()
                .map(
                        shop ->
                                CompletableFuture.supplyAsync(
                                        () -> String.format("%s å•†åº—ä»·æ ¼ä¸º %.2f", shop.getShopName(), shop.getPrice(product))
                                )
                )
                .collect(Collectors.toList());
```

ç”±äºä½ ä½¿ç”¨çš„`findPrices`æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª`List<String>`ï¼Œä½ éœ€è¦ç­‰å¾…æ‰€æœ‰çš„`future`æ‰§è¡Œå®Œæ¯•ï¼Œå°†å…¶æ‰€åŒ…å«çš„å€¼æŠ½å–å‡ºæ¥ï¼š

```java
public static List<String> findPrices(String product) {
    List<CompletableFuture<String>>
            futureList =
            shops
                    .parallelStream()
                    .map(
                            shop ->
                                    CompletableFuture.supplyAsync(
                                            () -> String.format("%s å•†åº—ä»·æ ¼ä¸º %.2f", shop.getShopName(), shop.getPrice(product))
                                    )
                    )
                    .collect(Collectors.toList());
    return futureList.stream().map(CompletableFuture::join).collect(Collectors.toList());
}
```

`CompletableFuture`ç±»ä¸­çš„`join`æ–¹æ³•å’Œ`Future`ä¸­çš„`get`æœ‰ç›¸åŒçš„å«ä¹‰ï¼Œå¹¶ä¸”ä¹Ÿå£°æ˜åœ¨`Future`æ¥å£ä¸­ï¼Œå”¯ä¸€çš„ä¸åŒä¹‹å¤„åœ¨äº`join`æ–¹æ³•ä¸ä¼šæŠ›å‡ºä»»ä½•æ£€æµ‹åˆ°çš„å¼‚å¸¸ã€‚

è¿™é‡Œä½¿ç”¨äº†ä¸¤ä¸ªä¸åŒçš„æµæ°´çº¿ï¼Œè€Œä¸æ˜¯åœ¨ä¸€ä¸ªæµæ°´çº¿ä¸Šä¸€ä¸ªæ¥ç€ä¸€ä¸ªçš„æ”¾ç½®ä¸¤ä¸ª`map`æ“ä½œï¼Œè¿™æ ·åšæ˜¯æœ‰åŸå› çš„ â€”â€” è€ƒè™‘åˆ°æµæ“ä½œä¹‹é—´çš„å»¶è¿Ÿç‰¹æ€§ï¼Œå¦‚æœä½ åœ¨å•ä¸€æµæ°´çº¿ä¸Šå¤„ç†æµï¼Œå‘å‘ä¸åŒå•†å®¶çš„è¯·æ±‚åªèƒ½ä»¥åŒæ­¥ã€é¡ºåºæ‰§è¡Œçš„æ–¹å¼æ‰ä¼šæˆåŠŸã€‚å› æ­¤ï¼Œæ¯ä¸ªåˆ›å»º`CompletableFuture`å¯¹è±¡åªèƒ½åœ¨å‰ä¸€ä¸ªæ“ä½œå®Œæˆä¹‹åæ‰§è¡ŒæŸ¥è¯¢æŒ‡å®šå•†å®¶çš„åŠ¨ä½œï¼š

![](https://raw.githubusercontent.com/zhangzhaolin/GraphBed/master/20190415/20190415095158.png)

è¿è¡Œç»“æœå¦‚ä¸‹ ï¼š

```
[BestPrice å•†åº—ä»·æ ¼ä¸º 135.12, LetsSaveBig å•†åº—ä»·æ ¼ä¸º 166.28, MyFavoriteShop å•†åº—ä»·æ ¼ä¸º 147.43, BuyItAll å•†åº—ä»·æ ¼ä¸º 179.01]
ä»£ç å®Œæˆæ—¶é•¿ : 2100 æ¯«ç§’
```

###  3.3 ğŸ”å¯»æ‰¾æ›´å¥½çš„æ–¹æ¡ˆ

æˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œå¹¶è¡Œæµå’Œ`CompletableFuture`çœ‹èµ·æ¥ä¸åˆ†ä¼¯ä»²ï¼Œè¿™æ˜¯å› ä¸ºï¼šä»–ä»¬å†…éƒ¨éƒ½é‡‡ç”¨çš„ç›¸åŒçš„é€šç”¨çº¿ç¨‹æ± ï¼Œé»˜è®¤éƒ½æ˜¯å›ºå®šæ•°ç›®çš„çº¿ç¨‹ï¼Œå…·ä½“çº¿ç¨‹æ•°å–å†³äº`Runtime.getRuntime().availableProcessors()`çš„è¿”å›å€¼ã€‚ç„¶è€Œï¼Œ`CompletableFuture`å…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ï¼Œå› ä¸ºå®ƒå…è®¸ä½ å¯¹çº¿ç¨‹æ± ï¼ˆ`Executor`ï¼‰è¿›è¡Œé…ç½®ï¼Œå°¤å…¶æ˜¯çº¿ç¨‹æ± çš„å¤§å°

### 3.4 ä½¿ç”¨å®šåˆ¶çš„æ‰§è¡Œå™¨

çº¿ç¨‹æ± å¤§å°å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å…¬å¼è¿›è¡Œè®¡ç®— ï¼š

$$
N_{threads} = N_{CPU} * U_{CPU} * (1 + W/C)
$$

å…¶ä¸­ï¼Œ

- $N_{CPU}$ è¡¨ç¤ºå¤„ç†å™¨æ ¸çš„æ•°é‡ï¼Œå¯ä»¥é€šè¿‡`Runtime.getRuntime().availableProcessors()`å¾—åˆ°
- $U_{CPU}$ è¡¨ç¤ºæœŸæœ›çš„CPUåˆ©ç”¨ç‡ï¼ˆä»‹äº0-1ä¹‹é—´ï¼‰
- $W/C$ æ˜¯ç­‰å¾…æ—¶é—´ä¸è®¡ç®—æ—¶é—´çš„æ¯”ç‡

åœ¨æˆ‘ä»¬è®¾è®¡çš„â€œæœ€ä½³ä»·æ ¼æŸ¥è¯¢å™¨â€ç¨‹åºä¸­ï¼Œæœ‰99%çš„æ—¶é—´éƒ½åœ¨ç­‰å¾…å•†åº—çš„å“åº”ï¼Œæ‰€ä»¥ä¼°ç®—çš„W/Cæ¯”ç‡ä¸º100ï¼›è¿™æ„å‘³ç€å¦‚æœä½ å¸Œæœ›CPUåˆ©ç”¨ç‡ä¸º100%ï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ªæ‹¥æœ‰400ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚åœ¨å®é™…æ“ä½œä¸­ï¼Œå¦‚æœä½ åˆ›å»ºçš„çº¿ç¨‹æ± æ•°ç›®æ¯”å•†åº—çš„æ•°ç›®å¤šï¼Œåè€Œæ˜¯ä¸€ç§æµªè´¹ï¼Œå› ä¸ºè¿™æ ·åšä¹‹åï¼Œçº¿ç¨‹æ± ä¸­çš„ä¸€äº›çº¿ç¨‹æ ¹æœ¬æ²¡æœ‰æœºä¼šè¢«ä½¿ç”¨ï¼›

å¤„äºè¿™ç§è€ƒè™‘ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰§è¡Œå™¨ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œä¸ä½ éœ€è¦æŸ¥è¯¢çš„å•†åº—æ•°ç›®è®¾å®šä¸ºä¸€ä¸ªå€¼ï¼Œè¿™æ ·æ¯ä¸€ä¸ªå•†åº—éƒ½ä¼šå¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼›ä¸è¿‡ä¸ºäº†é¿å…ç”±äºå•†åº—æ•°ç›®è¿‡å¤šè€Œå¯¼è‡´çš„æœåŠ¡å™¨è¶…è´Ÿè·è€Œå´©æºƒï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªä¸Šé™ï¼Œä¾‹å¦‚100ä¸ªçº¿ç¨‹ï¼š

```java
private static final Executor executor =
        Executors.newFixedThreadPool(Math.min(shops.size(), 100), new ThreadFactory() {
            @Override
            public Thread newThread(Runnable r) {
                Thread thread = new Thread(r);
                // ä½¿ç”¨å®ˆæŠ¤çº¿ç¨‹ â€”â€” è¿™ç§æ–¹å¼å°±ä¸ä¼šé˜»æ­¢ç¨‹åºçš„å…³åœ
                thread.setDaemon(true);
                return thread;
            }
        });
```

**Javaç¨‹åºæ— æ³•ç»ˆæ­¢æˆ–è€…é€€å‡ºä¸€ä¸ªæ­£åœ¨è¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œæ‰€ä»¥æœ€åå‰©ä¸‹çš„é‚£ä¸ªçº¿ç¨‹ä¼šç”±äºä¸€ç›´ç­‰å¾…æ— æ³•å‘ç”Ÿçš„äº‹ä»¶è€Œå¼•å‘é—®é¢˜ã€‚ä¸æ­¤ç›¸åï¼Œå¦‚æœå°†å¿åŸæ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼Œæ„å‘³ç€ç¨‹åºé€€å‡ºæ—¶å®ƒä¹Ÿé€€å‡ºã€‚**

ç°åœ¨ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªå¯æŸ¥è¯¢æŒ‡å®šå•†å“ä»·æ ¼çš„`CompletableFuture`å¯¹è±¡ï¼š

```java
public static List<String> findPrices(String product) {
    List<CompletableFuture<String>> futures =
            shops.stream()
                    .map(shop ->
                            CompletableFuture.supplyAsync
                                    (
                                            () -> String.format("%s å•†åº—ä»·æ ¼ä¸º %.2f", shop.getShopName(), shop.getPrice(product))
                                            ,
                                            executor
                                    )
                    ).collect(Collectors.toList());
    return futures.stream().map(CompletableFuture::join).collect(Collectors.toList());
}
```

æ”¹è¿›ä¹‹åçš„è¿è¡Œç»“æœä¸º ï¼š

```
[BestPrice å•†åº—ä»·æ ¼ä¸º 124.25, LetsSaveBig å•†åº—ä»·æ ¼ä¸º 112.12, MyFavoriteShop å•†åº—ä»·æ ¼ä¸º 143.98, BuyItAll å•†åº—ä»·æ ¼ä¸º 123.72]
ä»£ç å®Œæˆæ—¶é•¿ : 1074 æ¯«ç§’
```

### 3.5 ä½¿ç”¨å¹¶è¡Œæµè¿˜æ˜¯`CompletableFuture`

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä»€ä¹ˆæ˜¯è®¡ç®—å¯†é›†å‹å’ŒI/Oå¯†é›†å‹ï¼š

- è®¡ç®—å¯†é›†å‹

  è®¡ç®—å¯†é›†å‹ä¹Ÿè¢«ç§°ä¸ºCPUå¯†é›†å‹ï¼Œåœ¨å¤šé‡ç¨‹åºç³»ç»Ÿä¸­ï¼Œå¤§éƒ¨åˆ†æ—¶é—´ç”¨æ¥åšè®¡ç®—ã€é€»è¾‘åˆ¤æ–­ç­‰CPUçš„ç¨‹åºè¢«ç§°ä¹‹ä¸ºè®¡ç®—å¯†é›†å‹ï¼Œä¾‹å¦‚è®¡ç®—åœ†å‘¨ç‡è‡³å°æ•°ç‚¹ä¸€åƒä½ä»¥ä¸‹ï¼Œä¾¿æ˜¯è®¡ç®—å¯†é›†å‹çš„ç¨‹åºï¼›åˆä¾‹å¦‚å¯¹è§†é¢‘è¿›è¡Œé«˜æ¸…è§£ç ç­‰

- I/Oå¯†é›†å‹

  æ¶‰åŠåˆ°ç½‘ç»œã€ç£ç›˜I/Oçš„ä»»åŠ¡éƒ½æ˜¯IOå¯†é›†å‹ä»»åŠ¡

å¦‚æœæˆ‘ä»¬è¿›è¡Œçš„æ˜¯è®¡ç®—å¯†é›†å‹çš„æ“ä½œï¼Œå¹¶ä¸”æ²¡æœ‰IOï¼Œé‚£ä¹ˆæ¨èä½¿ç”¨`Stream`æ¥å£ï¼›åä¹‹ï¼Œå¦‚æœä½ å¹¶è¡Œçš„å·¥ä½œå•å…ƒè¿˜æ¶‰åŠåˆ°ç­‰å¾…I/Oçš„æ“ä½œï¼ˆåŒ…æ‹¬ç½‘ç»œè¿æ¥ç­‰ï¼‰ï¼Œé‚£ä¹ˆä½¿ç”¨`CompletableFuture`çµæ´»æ€§æ›´å¥½

## 4. å¯¹å¤šä¸ªå¼‚æ­¥ä»»åŠ¡è¿›è¡Œæµæ°´çº¿æ“ä½œ

æˆ‘ä»¬å‡è®¾æ‰€æœ‰çš„å•†åº—éƒ½å¯¹åº”åŒä¸€ä¸ªé›†ä¸­å¼çš„æŠ˜æ‰£æœåŠ¡ï¼Œè¯¥æœåŠ¡å¯¹åº”äº†äº”ç§ä¸åŒçš„æŠ˜æ‰£ä»£ç ï¼Œæ¯ä¸€ç§æŠ˜æ‰£ä»£ç éƒ½å¯¹åº”äº†ä¸åŒçš„æŠ˜æ‰£ç‡ï¼š

```java
public class Discount {
    @AllArgsConstructor
    public enum Code {
        NONE(0),
        SILVER(5),
        GOLD(10),
        PLATINUM(15),
        DIAMOND(20);
        private final int percentage;
    }
}
```

æˆ‘ä»¬å‡è®¾æ‰€æœ‰çš„å•†åº—éƒ½åŒæ„ä¿®æ”¹`getPrice`æ–¹æ³•çš„è¿”å›æ ·å¼ï¼Œç°åœ¨`getPrice`æ–¹æ³•ä¼šè¿”å›ä¸‹é¢æ ¼å¼çš„å­—ç¬¦ä¸² ï¼š

```
å•†åº—åç§°:ä»·æ ¼:å¯¹åº”çš„æŠ˜æ‰£ç 
```

```java
public String getPrice(String product) {
    double price = calculatePrice(product);
    Discount.Code code = Discount.Code.values()[random.nextInt(Discount.Code.values().length)];
    return String.format("%s:%.2f:%s", shopName, price, code);
}
private double calculatePrice(String product) {
    Utils.delay();
    return random.nextDouble() * product.charAt(0) + product.charAt(1);
}
```

æˆ‘ä»¬å¯¹å•†åº—è¿”å›å­—ç¬¦ä¸²çš„è§£ææ“ä½œå°è£…åˆ°äº†ä¸‹é¢çš„`Quote`ç±»ä¸­ ï¼š

```java
@AllArgsConstructor
@Data
public class Quote {
    private final String shopName;
    private final double price;
    private final Discount.Code code;
    public static Quote parse(String s) {
        String[] split = s.split(":");
        return new Quote(split[0], Double.parseDouble(split[1]), Discount.Code.valueOf(split[2]));
    }
}
```

`Discount`æŠ˜æ‰£æœåŠ¡è¿˜æä¾›äº†ä¸€ä¸ª`applyDiscount`æ–¹æ³•ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ª`Quote`å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºç”Ÿæˆè¯¥`Quote`çš„å•†åº—ä¸­çš„æŠ˜æ‰£ä»·æ ¼ï¼š

```java
public class Discount {

    @AllArgsConstructor
    public enum Code {
        NONE(0),
        SILVER(5),
        GOLD(10),
        PLATINUM(15),
        DIAMOND(20);
        private final int percentage;
    }

    public static String applyDiscount(Quote quote) {
        return String.format("%sä»·æ ¼ä¸º%.2f", quote.getShopName(), apply(quote.getPrice(), quote.getCode()));
    }
    
    private static double apply(double price, Code code) {
        Utils.delay();
        return price * (100 - code.percentage) / 100;
    }
}
```

![](https://raw.githubusercontent.com/zhangzhaolin/GraphBed/master/20190415/20190415151205.png)

### 4.1 æ„é€ åŒæ­¥å’Œå¼‚æ­¥æ“ä½œ

```java
private static List<String> findPrices(String product) {
    List<CompletableFuture<String>> priceFutures =
            shops.stream().map(
                    shop -> CompletableFuture.supplyAsync(() -> {
                        return shop.getPrice(product);
                    }, myExecutor)).map(future -> future.thenApply(Quote::parse))
                    .map(future -> future.thenCompose(quote -> {
                        return CompletableFuture.supplyAsync(() -> Discount.applyDiscount(quote), myExecutor);
                    })).collect(Collectors.toList());
    return priceFutures.stream().map(CompletableFuture::join).collect(Collectors.toList());
}
```

![](https://raw.githubusercontent.com/zhangzhaolin/GraphBed/master/20190419/20190419143342.png)

Java8çš„`CompletableFuture`æä¾›äº†åä¸º`thenCompose`çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å…è®¸ä½ åˆ›å»ºä¸¤ä¸ªå¼‚æ­¥æ“ä½œè¿›è¡Œæµæ°´çº¿ï¼Œç¬¬ä¸€ä¸ªæ“ä½œå®Œæˆæ—¶ï¼Œå°†å…¶ç»“æœä¼ é€’ç»™äº†ç¬¬äºŒä¸ªæ“ä½œï¼›å½“ç¬¬ä¸€ä¸ª`CompletableFuture`æ‰§è¡Œå®Œæ¯•åï¼Œå®ƒçš„ç»“æœå°†ä¼šä½œä¸º`thenCompose`çš„å‚æ•°ï¼Œ`thenCompose`å‡½æ•°çš„è¿”å›å€¼æ˜¯ä»¥ç¬¬ä¸€ä¸ª`CompletableFuture`çš„è¿”å›å€¼åšè¾“å…¥è®¡ç®—å‡ºçš„ç¬¬äºŒä¸ª`CompletableFuture`å¯¹è±¡ã€‚

é€šå¸¸è€Œè¨€ï¼Œåç§°ä¸­ä¸å¸¦æœ‰`Async`çš„æ–¹æ³•å’Œå®ƒçš„å‰ä¸€ä¸ªä»»åŠ¡ä¸€æ ·ï¼Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œï¼›è€Œåç§°ä»¥`Async`ç»“å°¾çš„æ–¹æ³•ä¼šå°†åç»­çš„ä»»åŠ¡æäº¤åˆ°ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæ‰€ä»¥æ¯ä¸ªä»»åŠ¡éƒ½æ˜¯ç”±ä¸åŒçš„çº¿ç¨‹å¤„ç†çš„ã€‚å°±è¿™ä¸ªä¾‹å­è€Œè¨€ï¼Œç¬¬äºŒä¸ª`CompletableFuture`çš„ç»“æœå–å†³äºç¬¬ä¸€ä¸ª`CompletableFuture`ï¼Œæ‰€ä»¥æ— è®ºä½ ç”¨å“ªä¸€ä¸ªç‰ˆæœ¬çš„æ–¹æ³•æ¥å¤„ç†`CompletableFuture`ï¼Œå¯¹äºå¤§è‡´èŠ±é”€æ—¶é—´éƒ½æ²¡æœ‰å¤šå¤§çš„å·®åˆ«ã€‚

### 4.2 å°†ä¸¤ä¸ª`CompletableFuture`å¯¹è±¡æ•´åˆèµ·æ¥

åœ¨ä¸Šä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å¯¹ä¸€ä¸ª`CompletableFuture`å¯¹è±¡è°ƒç”¨äº†ä¸€ä¸ª`thenCompose`æ–¹æ³•ï¼Œå¹¶å‘å…¶ä¼ é€’ç»™äº†ç¬¬äºŒä¸ª`CompletableFuture`ï¼Œç¬¬äºŒä¸ª`CompletableFuture`åˆéœ€è¦ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰§è¡Œç»“æœä½œä¸ºè¾“å…¥ï¼›ä½†æ˜¯ï¼Œå¦ä¸€ä¸ªå¸¸è§æƒ…å†µå°±æ˜¯ï¼Œéœ€è¦å°†ä¸¤ä¸ªæ¯«æ— è”ç³»çš„`CompletableFuture`è”ç³»èµ·æ¥ï¼Œè€Œä¸”ä½ ä¸å¸Œæœ›ç­‰åˆ°ç¬¬ä¸€ä¸ªä»»åŠ¡ç»“æŸå®Œå…¨ç»“æŸä¹‹åæ‰å¼€å§‹ç¬¬äºŒé¡¹ä»»åŠ¡ã€‚

è¿™ç§æƒ…å†µä¸‹ï¼Œ æˆ‘ä»¬åº”è¯¥ä½¿ç”¨`thenCombine`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç¬¬äºŒå‚æ•°ä¸º`BiFunction`ï¼Œè¿™ä¸ªå‚æ•°å®šä¹‰äº†å½“ä¸¤ä¸ª`CompletableFuture`å¯¹è±¡å®Œæˆè®¡ç®—åç»“æœå¦‚ä½•è¿›è¡Œåˆå¹¶ã€‚å’Œ`thenCompose`ä¸€æ ·ï¼Œ`thenCombine`ä¹Ÿæœ‰ä¸€ä¸ª`Async`çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œï¼Œå¦‚æœä½¿ç”¨`thenCombineAsync`ä¼šå¯¼è‡´`BiFunction`ä¸­å®šä¹‰çš„åˆå¹¶æ“ä½œè¢«æäº¤åˆ°çº¿ç¨‹æ± ä¸­ï¼Œç”±å¦ä¸€ä¸ªä»»åŠ¡ä»¥å¼‚æ­¥çš„æ–¹å¼æ‰§è¡Œã€‚

![](https://raw.githubusercontent.com/zhangzhaolin/GraphBed/master/2019/04/20190422134445.png)

```java
List<CompletableFuture<Double>> futures = shops
        .stream().map(
                shop -> CompletableFuture.supplyAsync(() -> shop.getPrice(product), myExecutor)
        )
        .map(strFuture -> strFuture.thenApply(Quote::parse))
        .map(
                quoteFuture -> quoteFuture.thenCompose(
                        quote -> CompletableFuture
                                .supplyAsync(quote::getPrice)
                                .thenCombine(
                                        CompletableFuture.supplyAsync(
                                                () -> ExchangeService.getRate(Money.CNY, Money.USD), myExecutor
                                        )
                                        ,
                                        (price, rate) -> price * rate
                                )
                )
        )
        .collect(Collectors.toList());
```

## 5. å“åº”`CompletableFuture`çš„`completion`äº‹ä»¶

ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å®ç°çš„`findPrices`æ–¹æ³•åªæœ‰åœ¨å–å¾—æ‰€æœ‰å•†åº—çš„è¿”å›å€¼æ—¶æ‰æ˜¾ç¤ºå•†å“çš„ä»·æ ¼ï¼Œè€Œæ‰€æœŸæœ›çš„æ˜¯ï¼Œåªè¦æœ‰å•†åº—è¿”å›å•†åº—ä»·æ ¼å°±åœ¨ç¬¬ä¸€æ—¶é—´æ˜¾ç¤ºè¿”å›å€¼ï¼Œä¸å†ç­‰å¾…é‚£äº›è¿˜æœªè¿”å›çš„å•†åº—ï¼š

```java
private static Stream<CompletableFuture<String>> findPricesStream(String product) {
    return shops.stream()
            .map(shop -> CompletableFuture.supplyAsync(() -> shop.getPrice(product), myExecutor))
            .map(strFuture -> strFuture.thenApply(Quote::parse))
            .map(quoteFuture -> quoteFuture.thenCompose(
                    quote -> CompletableFuture.supplyAsync(() -> Discount.applyDiscount(quote), myExecutor)
            ));
}
```

Java8ä¸­çš„`CompletableFuture`é€šè¿‡`thenAccept`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨æ¯ä¸€ä¸ª`CompletableFuture`ä¸Šæ³¨å†Œäº†ä¸€ä¸ªæ“ä½œï¼Œè¯¥æ“ä½œä¼šåœ¨`CompletableFuture`å®Œæˆæ‰§è¡Œåä½¿ç”¨å®ƒçš„è¿”å›å€¼ã€‚ï¼ˆ`thenAccept`å®šä¹‰äº†å¦‚ä½•å¤„ç†`CompletableFuture`çš„è¿”å›ç»“æœï¼Œä¸€æ—¦`CompletableFuture`è®¡ç®—å¾—åˆ°äº†ç»“æœï¼Œå®ƒå°±è¿”å›ä¸€ä¸ª`CompletableFuture<Void>`ï¼‰

```java
CompletableFuture[] futures =
        findPricesStream("MyPhone")
                .map(future -> future.thenAccept(System.out::println))
                .toArray(CompletableFuture[]::new);
CompletableFuture.allOf(futures).join();
```

`allOf`æ¥å—ä¸€ä¸ª`CompletableFuture`å¯¹è±¡æ•°ç»„ï¼Œæ•°ç»„ä¸­æ‰€æœ‰å¯¹è±¡æ‰§è¡Œå®Œæˆä¹‹åï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª`CompletableFuture<Void>`å¯¹è±¡ã€‚**è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ è¦ç­‰å¾…æœ€åˆ`Stream`ä¸­æ‰€æœ‰`CompletableFuture`å¯¹è±¡æ‰§è¡Œå®Œæ¯•ï¼Œå¯¹`allOf`æ–¹æ³•è¿”å›çš„`CompletableFuture`æ‰§è¡Œ`join`æ“ä½œæ˜¯ä¸€ä¸ªä¸é”™çš„ä¸»æ„**

ç„¶è€Œï¼Œåœ¨å¦å¤–ä¸€äº›åœºæ™¯ä¸­ï¼Œå¦‚æœä½ æƒ³è¦`CompletableFuture`å¯¹è±¡æ•°ç»„ä¸­æœ‰ä»»ä½•ä¸€ä¸ªæ‰§è¡Œå®Œæ¯•å°±ä¸å†ç­‰å¾…ï¼Œä½ å¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹æ³•`anyOf`ï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—ä¸€ä¸ª`CompletableFuture`å¯¹è±¡æ•°ç»„ï¼Œè¿”å›ç”±ç¬¬ä¸€ä¸ªæ‰§è¡Œå®Œæ¯•çš„`CompletableFuture`å¯¹è±¡çš„è¿”å›å€¼æ„æˆçš„`CompletableFuture<Object>`ï¼š

```java
CompletableFuture.anyOf(futures).join();
```

## 6. æ€»ç»“

![](https://raw.githubusercontent.com/zhangzhaolin/GraphBed/master/2019/04/20190422170816.png)





