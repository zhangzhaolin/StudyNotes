#  ç¬¬ä¸‰ç«  é«˜çº§è£…é…

[TOC]

## ç¯å¢ƒä¸profile

### é…ç½®profile bean

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸åŒå¼€å‘ç¯å¢ƒå¯èƒ½ä¼šå‡ºç°ä»£ç ä¸åŒçš„æƒ…å†µï¼Œæ¯”æ–¹è¯´ï¼šä¸€èˆ¬å¼€å‘å’Œæµ‹è¯•ä¼šæœ‰ä¸¤ä¸ªä¸åŒçš„ç¯å¢ƒå’Œæ•°æ®åº“ç­‰ç­‰ã€‚Springå¼•å…¥äº†`Profile`çš„åŠŸèƒ½ï¼Œè¦ä½¿ç”¨`Profile`ï¼Œä½ éœ€è¦å°†ä¸åŒçš„`Bean`æ•´ç†åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ª`Profile`ä¸­ï¼Œå°†åº”ç”¨éƒ¨ç½²åˆ°æ¯ä¸ªç¯å¢ƒçš„æ—¶å€™ï¼Œéœ€ç¡®å®šå¯¹åº”çš„`Profile`å¤„äºæ¿€æ´»çŠ¶æ€ï¼ˆ`active`ï¼‰

åœ¨Javaä¸­ï¼Œå¯ä»¥ä½¿ç”¨`@Profile`æ³¨è§£æŒ‡å®šæŸä¸ª`bean`å±äºå“ªä¸ª`profile`

>  `HelloService.class`

```java
package com.shiwa.spring;

/**
 * å®šä¹‰æ¥å£,åœ¨å®é™…ä¸­å¯èƒ½æ˜¯ä¸€ä¸ªæ•°æ®æº
 * åœ¨å¼€å‘çš„æ—¶å€™ä¸å®é™…éƒ¨ç½²çš„æ—¶å€™åˆ†åˆ«ä½¿ç”¨ä¸åŒçš„å®ç°
 *
 * @author zhang
 */
public interface HelloService {
    public String sayHello();
}
```

> DevHelloServiceImpl.java

```java
package com.shiwa.spring.dev;

/**
 * æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒä¸‹éœ€è¦ä½¿ç”¨çš„ç±»
 *
 * @author zhang
 */
@Component("helloService")
@PropertySource(value = "classpath:/development/config.properties")
public class DevHelloServiceImpl implements HelloService {

    @Value("${name}")
    private String name;

    @Override
    public String sayHello() {
        return String.format("hello,I'm %s,this is a development environment!", name);
    }
}
```

> ProductHelloServiceImpl.java

```java
package com.shiwa.spring.product;

/**
 * æ¨¡æ‹Ÿå¼€å‘ç¯å¢ƒä¸‹ä½¿ç”¨çš„ç±»
 *
 * @author zhang
 */
@Component("helloService")
@PropertySource(value = "classpath:/product/config.properties")
public class ProductHelloServiceImpl implements HelloService {

    @Value("${name}")
    private String name;

    @Override
    public String sayHello() {
        return String.format("hello,I'm %s,this is a produce environment!", name);
    }
}
```

> DevelopmentConfiguration.class

```java
package com.shiwa.spring.config;

@Configuration
@Profile(value = "development")
@ComponentScan(basePackageClasses = DevHelloServiceImpl.class)
public class DevelopmentConfiguration {
}
```

> ProductConfiguration.class

```java
package com.shiwa.spring.config;

@Configuration
@Profile(value = "product")
@ComponentScan(basePackageClasses = ProductHelloServiceImpl.class)
public class ProductConfiguration {
}
```

> RootConfiguration.java

```java
package com.shiwa.spring.config;

@Configuration
@ComponentScan(basePackageClasses = {RootConfiguration.class})
public class RootConfiguration {
}
```

> ç¼–å†™æµ‹è¯•ç±»

```java
@ExtendWith(SpringExtension.class)
@SpringJUnitConfig(value = RootConfiguration.class)
@ActiveProfiles(value = "development")
public class SpringContextText {

    @Autowired
    private HelloService helloService;

    @Test
    public void profile() {
        Assertions.assertNotNull(helloService);
        System.out.println(helloService.sayHello());
    }
    
}
```

`@Profile` æ³¨è§£ä¸ä»…å¯ä»¥åŠ åˆ°`@Configuration`çš„ä¸‹æ–¹ï¼Œè¿˜å¯ä»¥åŠ åˆ°æ–¹æ³•çº§åˆ«ä¸Š(`@Bean`)ï¼š

```java
@Configuration
public class DataSourceConfiguration{
    
    @Bean
    @Profile(value = "dev")
    public DataSource devDataSource(){
        // ...
    }
    
    @Bean
    @Profile(value = "product")
    public DataSource proDataSource(){
        // ...
    }
    
}
```

è¡¨ç¤ºä»…æœ‰å½“`@Profile`ä¸­çš„ç¯å¢ƒæ¿€æ´»æ—¶ï¼ˆä¹Ÿå°±æ˜¯ä¾‹å­ä¸­çš„prod,dev...ï¼‰ï¼Œæ‰å¯ä»¥åˆ›å»ºç›¸åº”çš„bean

é™¤äº†åœ¨Javaæ–‡ä»¶ä¸­åŠ ä¸Šæ³¨è§£ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡XMLé…ç½®æ–‡ä»¶çš„æ–¹æ³•æ¥é…ç½®ç›¸åº”çš„profileï¼š

> spring-config.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jdbc="http://www.springframework.org/schema/jdbc"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd"
       profile="prod">

    <jdbc:embedded-database id="dataSource">
        <jdbc:script location="classpath:main/example/sql/dev.sql"/>
        <jdbc:script location="classpath*:main/example/sql/prod.sql"/>
    </jdbc:embedded-database>

    <context:component-scan base-package="main.example"/>

</beans>
```

å½“prodçš„profileè¢«æ¿€æ´»æ—¶ï¼Œspring-config.xmlæ‰ä¼šè¢«ç”¨åˆ°ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥åœ¨ä¸€ä¸ªXMLæ–‡ä»¶ä¸­é€šè¿‡`<beans>`æ ‡ç­¾åµŒå¥—å®šä¹‰å¤šä¸ªprofile

> é‡å¤ä½¿ç”¨ `<beans>` å…ƒç´ æ¥æŒ‡å®šå¤šä¸ªprofile

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jdbc="http://www.springframework.org/schema/jdbc"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

    <beans profile="qa">
        <bean>
            ...
        </bean>
    </beans>

    <beans profile="prod">
        <bean>
        	....
        </bean>
    </beans>

</beans>
```

### æ¿€æ´»profile

æ¿€æ´»profileéœ€è¦ä¾èµ–ä¸¤ä¸ªç‹¬ç«‹çš„å±æ€§ï¼š

```
spring.profiles.active // ä¼˜å…ˆçº§è¦æ¯”defaulté«˜
spring.profiles.default // å¦‚æœactiveæ²¡æœ‰è®¾ç½®ï¼Œæ‰ä¼šæŸ¥æ‰¾defaultä¸­çš„å€¼
```

**ç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨`spring.profiles.active`ä¸­æ‰€è®¾ç½®çš„profile**

å¦‚æœ`spring.profiles.active`å’Œ`spring.profiles.default`å‡æ²¡æœ‰è®¾ç½®çš„è¯ï¼Œé‚£å°±æ²¡æœ‰æ¿€æ´»çš„profileï¼Œå› æ­¤ï¼Œåªä¼šåˆ›å»ºé‚£äº›æ²¡æœ‰å®šä¹‰åœ¨profileä¸­çš„bean ã€‚

æœ‰å¤šç§æ–¹å¼æ¥è®¾ç½®è¿™ä¸¤ä¸ªå±æ€§ï¼š
- ä½œä¸º`DispatcherServlet`çš„åˆå§‹åŒ–å‚æ•°
- ä½œä¸ºWebåº”ç”¨çš„ä¸Šä¸‹æ–‡å‚æ•°
- ä½œä¸ºJNDIæ¡ç›®
- ä½œä¸ºç¯å¢ƒå˜é‡
- ä½œä¸ºJVMçš„ç³»ç»Ÿå±æ€§
- åœ¨é›†æˆæµ‹è¯•ä¸Šï¼Œä½¿ç”¨`@ActiveProfiles`æ³¨è§£è®¾ç½®

> åœ¨webåº”ç”¨ä¸­çš„web.xmlä¸­è®¾ç½®é»˜è®¤çš„profile
> web.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
         version="3.1">

    <welcome-file-list>
        <welcome-file>index.jsp</welcome-file>
    </welcome-file-list>

    <!-- ä¸ºä¸Šä¸‹æ–‡è®¾ç½®é»˜è®¤çš„profile -->
    <context-param>
        <param-name>spring.profiles.default</param-name>
        <param-value>dev</param-value>
    </context-param>

    <listener>
        <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
    </listener>

    <!-- Spring Configuration -->
    <servlet>
        <servlet-name>appServlet</servlet-name>
        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
        <init-param>
            <!-- ä¸ºservleté…ç½®é»˜è®¤çš„profile -->
            <param-name>spring.profiles.default</param-name>
            <param-value>dev</param-value>
        </init-param>
        <load-on-startup>1</load-on-startup>
    </servlet>

    <servlet-mapping>
        <servlet-name>appServlet</servlet-name>
        <url-pattern>/</url-pattern>
    </servlet-mapping>

</web-app>
```

### ä½¿ç”¨profileè¿›è¡Œæµ‹è¯•

Springæä¾›äº† `@ActiveProfiles` æ³¨è§£ï¼Œæ¥æŒ‡å®šè¿è¡Œæµ‹è¯•æ—¶éœ€è¦æ¿€æ´»å“ªä¸ªprofile

```java
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = "classpath:spring-config.xml")
@ActiveProfiles("prod")
public class UserDaoTest {
    // ...
}
```

## æ¡ä»¶åŒ–çš„bean

ğŸ”ºå‡å¦‚æˆ‘ä»¬å¸Œæœ›æŸä¸ªbeanåªæœ‰å½“å¦ä¸€ä¸ªç‰¹å®šçš„beanå£°æ˜äº†ä¹‹åæ‰ä¼šåˆ›å»ºï¼Œæˆ–è€…éœ€è¦æŸä¸ªç‰¹å®šçš„ç¯å¢ƒå˜é‡æ‰ä¼šåˆ›å»ºï¼Œå°±éœ€è¦ç”¨åˆ° `@Conditional` æ³¨è§£

**å®ƒå¯ä»¥ç”¨åœ¨å¸¦æœ‰ `@Bean` æ³¨è§£çš„æ–¹æ³•ä¸Šï¼Œå¦‚æœç»™å®šçš„æ¡ä»¶è®¡ç®—ç»“æœä¸ºtrueï¼Œå°±åˆ›å»ºè¿™ä¸ªbeanï¼Œå¦åˆ™å°±ä¸åˆ›å»ºã€‚**

ä¾‹å¦‚ï¼Œå‡è®¾æœ‰ä¸€ä¸ª`MagicBean`çš„ç±»ï¼Œå½“è®¾ç½®äº†magicç¯å¢ƒå±æ€§çš„æ—¶å€™ï¼ŒSpringæ‰ä¼šå®ä¾‹åŒ–è¿™ä¸ªç±»ï¼š

> `MagicBeanConfig.class`

```java
@Configuration
public class MagicBeanConfig {

    @Bean
    @Conditional(MagicExistsCondition.class)
    public MagicBean magicBean(){
        return new MagicBean();
    }

}
```

> Conditional.class

```java
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface Conditional {
    Class<? extends Condition>[] value();
}
```

`@Conditional` ç»™å®šäº†ä¸€ä¸ªclass ï¼Œå®ƒæŒ‡æ˜äº†ä¸€ä¸ªæ¡ä»¶ â€”â€” åœ¨æœ¬ä¾‹ä¸­ï¼Œä¹Ÿå°±æ˜¯ `MagicExistsCondition` ç±» ã€‚`MagicExistsCondition`éœ€è¦å®ç°`Condition`æ¥å£ã€‚

`@Conditional` å°†ä¼šé€šè¿‡ Condition æ¥å£è¿›è¡Œå¯¹æ¯”ï¼š

```java
@FunctionalInterface
public interface Condition {
    boolean matches(ConditionContext var1, AnnotatedTypeMetadata var2);
}
```

**è®¾ç½®ç»™ `@Conditional` çš„ç±»å¯ä»¥æ˜¯ä»»æ„å®ç°äº†`Condition` æ¥å£çš„ç±»å‹** ï¼Œå®ç° `Condition`æ¥å£éœ€è¦å®ç°`matches()`æ–¹æ³•ã€‚å¦‚æœ`matches()`æ–¹æ³•è¿”å› true ï¼Œ é‚£ä¹ˆå°±ä¼šåˆ›å»ºå¸¦æœ‰ `@Conditional` æ³¨è§£çš„beanï¼Œå¦åˆ™å°±ä¸ä¼šåˆ›å»ºè¿™äº› bean

> `MagicExistsCondition.class`

```java
public class MagicExistsCondition implements Condition {

    public boolean matches(ConditionContext conditionContext, AnnotatedTypeMetadata annotatedTypeMetadata) {
        Environment environment = conditionContext.getEnvironment();
        // æ£€æŸ¥ç¯å¢ƒä¸­æ˜¯å¦å­˜åœ¨magicçš„ç¯å¢ƒå±æ€§
        return environment.containsProperty("magic");
    }
}
```

> MainTest.class â€”â€” æµ‹è¯•ç±»

```java
public class MainTest {
    public static void main(String []args){
        System.setProperty("magic","true");
        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(MagicBeanConfig.class);
        // æ‰“å° ture
        System.out.println(context.containsBean("magicBean"));
        context.close();
    }
}
```

ğŸ”º`Condition`å®ç°çš„è€ƒé‡è¦æ¯”æœ¬ä¾‹ä¸­çš„æ›´å¤šï¼Œ`mathes()`æ–¹æ³•ä¼šå¾—åˆ°`ConditionContext`å’Œ`AnnotatedTypeMetadata` å¯¹è±¡ç”¨æ¥åšå‡ºå†³ç­– ã€‚

`ConditionContext `æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¤§è‡´å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public interface ConditionContext {
    // æ£€æŸ¥beanå®šä¹‰
    BeanDefinitionRegistry getRegistry();
    // æ£€æŸ¥beanæ˜¯å¦å­˜åœ¨ï¼Œç”šè‡³æ¢æŸ¥beançš„å±æ€§
    ConfigurableListableBeanFactory getBeanFactory();
    // æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨ä»¥åŠå®ƒçš„å€¼æ˜¯ä»€ä¹ˆ
    Environment getEnvironment();
    // è¿”å›ResourceLoaderæ‰€åŠ è½½çš„èµ„æº
    ResourceLoader getResourceLoader();
    // åŠ è½½å¹¶æ£€æŸ¥ç±»æ˜¯å¦å­˜åœ¨
    ClassLoader getClassLoader();
}
```

`AnnotatedTypeMetadata `èƒ½è®©æˆ‘ä»¬æ£€æŸ¥å¸¦æœ‰ `@Bean` æ³¨è§£çš„æ–¹æ³•ä¸Šè¿˜æœ‰ä»€ä¹ˆå…¶ä»–çš„æ³¨è§£ ï¼Œ `AnnotatedTypeMetadata `ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œä»–å¦‚ä¸‹æ‰€ç¤º ï¼š

```java
public interface AnnotatedTypeMetadata {
	// åˆ¤æ–­æ–¹æ³•æ˜¯å¦è¿˜æœ‰å…¶ä»–æ³¨è§£
    boolean isAnnotated(String annotationName);
	
	// æ£€ç´¢ç»™å®šæ³¨è§£ç±»å‹çš„å±æ€§ä»¥åŠå±æ€§å€¼
    @Nullable
    Map<String, Object> getAnnotationAttributes(String annotationName);
	
    @Nullable
    Map<String, Object> getAnnotationAttributes(String annotationName, boolean classValuesAsString);

    @Nullable
    MultiValueMap<String, Object> getAllAnnotationAttributes(String var1);

    @Nullable
    MultiValueMap<String, Object> getAllAnnotationAttributes(String var1, boolean var2);
}
```

è¿”å›åˆ°è¿™ç¯‡ç¬”è®°åˆšå¼€å§‹çš„åœ°æ–¹ï¼Œæˆ‘ä»¬çœ‹ä¸‹ `@Profile` æ˜¯å¦‚ä½•å®ç°çš„ï¼š

```java
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Conditional(ProfileCondition.class)
public @interface Profile {
	String[] value();
}
```

`@Profile` æœ¬èº«ä¹Ÿæ˜¯ç”¨äº† `@Conditional` æ³¨è§£ ï¼Œå¹¶å¼•ç”¨`ProfileCondition` ä½œä¸º Condition çš„å®ç° ã€‚

> ProfileCondition æ£€æµ‹æŸä¸ª bean profile æ˜¯å¦å¯ç”¨

```java
class ProfileCondition implements Condition {
	@Override
	public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
	    // è·å–ç”¨äº@Profileæ³¨è§£çš„æ‰€æœ‰å±æ€§
		MultiValueMap<String, Object> attrs = metadata.getAllAnnotationAttributes(Profile.class.getName());
		if (attrs != null) {
		    // è·å–valueå±æ€§
			for (Object value : attrs.get("value")) {
			    // æ£€æŸ¥valueå±æ€§ä¸­çš„profileæ˜¯å¦å¤„äºæ¿€æ´»çŠ¶æ€
				if (context.getEnvironment().acceptsProfiles((String[]) value)) {
					return true;
				}
			}
			return false;
		}
		return true;
	}
}
```

## è‡ªåŠ¨å¤„ç†è£…é…çš„æ­§ä¹‰æ€§

ä»…æœ‰ä¸€ä¸ªbeanåŒ¹é…æ‰€éœ€çš„ç»“æœæ—¶ ï¼Œè‡ªåŠ¨è£…é…æ‰æ˜¯æœ‰æ•ˆçš„ ã€‚å¦‚æœä¸ä»…æœ‰ä¸€ä¸ªbeanèƒ½å¤ŸåŒ¹é…ç»“æœçš„è¯ ï¼Œè¿™ç§æ­§ä¹‰æ€§ä¼šé˜»ç¢ Spring è‡ªåŠ¨è£…é…å±æ€§ ã€æ„é€ å™¨å‚æ•°æˆ–è€…æ–¹æ³•å‚æ•° ã€‚

**åœ¨å‘ç”Ÿæ­§ä¹‰æ—¶ï¼Œå¯ä»¥é€‰æ‹©beanä¸­çš„æŸä¸€ä¸ªè®¾ä¸ºé¦–é€‰ï¼ˆPrimaryï¼‰çš„bean ã€‚æˆ–è€…ä½¿ç”¨é™å®šç¬¦ï¼ˆQuailfierï¼‰æ¥å¸®åŠ©Springå°†å¯é€‰çš„beançš„èŒƒå›´ç¼©å°åˆ°åªæœ‰ä¸€ä¸ªbean ã€‚**

### æ ‡å¿—é¦–é€‰çš„bean --- @Primary

> ç”œç‚¹çš„ä¾‹å­

```java
public interface Dessert {
    void play();
}

@Component
public class Cake implements Dessert {
    // ...
}

@Component
public class Cookie implements Dessert {
    // ...
}

@Component
public class IceCream implements Dessert {
    // ...
}

```

åœ¨æœ¬ä¾‹ä¸­ï¼Œ `Dessert` æ˜¯ä¸€ä¸ªæ¥å£ ï¼Œå¹¶ä¸”æœ‰ä¸‰ä¸ªç±»å®ç°äº†è¿™ä¸ªæ¥å£ ã€‚å› ä¸ºè¿™ä¸‰ä¸ªç±»å‡ä½¿ç”¨äº† `@Component` æ³¨è§£ ï¼Œ åœ¨ç»„ä»¶æ‰«ææ—¶ ï¼Œèƒ½å¤Ÿå‘ç°ä»–ä»¬å¹¶ä¸”å°†å…¶åˆ›å»ºä¸ºSpringä¸Šä¸‹æ–‡å‚æ•°çš„bean ã€‚

```java
@Component
public class DessertMachine implements Machine {
    private Dessert dessert;
    @Autowired
    public void setDessert(Dessert dessert){
        this.dessert = dessert;
    }
    public void play(){
        dessert.play();
    }
}
```

å½“Springè¯•å›¾è£…é… `setDessert()` ä¸­çš„ `Dessert` å‚æ•°æ—¶ ï¼Œå®ƒå¹¶æ²¡æœ‰å”¯ä¸€ã€æ— æ­§ä¹‰çš„å¯é€‰å€¼ ã€‚Springä¼šæŠ›å‡ºç›¸åº”çš„å¼‚å¸¸ ã€‚

åœ¨Springä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `@Primary` æ¥è¡¨è¾¾æœ€å–œæ¬¢çš„æ–¹æ¡ˆï¼Œ `@Primary`å’Œ`@Component`ç»„åˆç”¨åœ¨ç»„ä»¶æ‰«æçš„beanä¸Šï¼Œä¾‹å¦‚ï¼š

```java
@Primary
@Component
public class IceCream implements Dessert {
    // ...
}
```

`@Primary` ä¹Ÿå¯ä»¥ä¸ `@Bean`ç»„åˆç”¨åœ¨Java é…ç½®çš„bean å£°æ˜ä¸­ã€‚

å¦‚æœä½ ä½¿ç”¨XMLé…ç½®beançš„è¯ï¼Œ`<bean>`å…ƒç´ æœ‰ä¸€ä¸ª`primary`å±æ€§æ¥æŒ‡å®šé¦–é€‰çš„bean ã€‚

```xml
<bean id="iceCream" class="com.desserteater.IceCream" primary="true"/>
```

å½“æ—¶ï¼Œå¦‚æœä½ æ ‡è¯†äº†ä¸¤ä¸ªæˆ–è€…æ›´å¤šçš„é¦–é€‰bean ï¼Œé‚£ä¹ˆå®ƒå°±æ— æ³•æ­£å¸¸å·¥ä½œäº†ã€‚

### é™å®šè‡ªåŠ¨è£…é…çš„bean

**`@Qualifier` æ³¨è§£æ˜¯ä½¿ç”¨é™å®šç¬¦çš„ä¸»è¦æ–¹å¼ ï¼Œ å¯ä»¥å’Œ `@Autowired` ååŒä½¿ç”¨ï¼Œåœ¨æ³¨å…¥çš„æ—¶å€™æŒ‡å®šæƒ³è¦æ³¨å…¥å“ªä¸€ä¸ªbean ã€‚**

```java
@Autowired
@Qualifier("iceCream")
public void setDessert(Dessert dessert){
    this.dessert = dessert;
}
```

ä¸º`@Qualifier`æ³¨è§£æ‰€è®¾ç½®çš„å‚æ•°å°±æ˜¯æƒ³è¦æ³¨å…¥çš„beançš„ID ã€‚å› ä¸ºæ‰€æœ‰ä½¿ç”¨ `@Component` æ³¨è§£çš„å£°æ˜çš„ç±»éƒ½ä¼šåˆ›å»ºä¸ºbean ï¼Œå¹¶ä¸”beançš„IDä¸ºé¦–å­—æ¯å˜ä¸ºå°å†™çš„ç±»åï¼Œæ‰€ä»¥ï¼Œ`@Qualifier("iceCream")` æŒ‡å‘çš„æ˜¯ç»„ä»¶æ‰«ææ—¶æ‰€åˆ›å»ºçš„beanï¼Œå¹¶ä¸”è¿™ä¸ªbeanæ˜¯ `IceCream` çš„å®ä¾‹ ã€‚

**è¿™é‡Œçš„é—®é¢˜æ˜¯å¦‚æœé‡æ„äº†`IceCream`ç±»ï¼Œbeançš„IDå’Œé»˜è®¤çš„é™å®šç¬¦å°±ä¼šå˜ï¼Œè¿™é‡Œå°±æ— æ³•åŒ¹é…`setDessert()`ä¸­æŒ‡å®šçš„é™å®šç¬¦ ã€‚è‡ªåŠ¨è£…é…ä¼šå¤±è´¥ ã€‚**

æˆ‘ä»¬å¯ä»¥ä¸ºbeanè®¾ç½®è‡ªå·±çš„é™å®šç¬¦ï¼Œè€Œä¸æ˜¯ä¾èµ–äºå°†bean IDä½œä¸ºé™å®šç¬¦ã€‚éœ€è¦åšçš„å°±æ˜¯åœ¨beanå£°æ˜ä¸Šæ·»åŠ `@Qualifier`æ³¨è§£ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥ä¸`@Component`ç»„åˆä½¿ç”¨ã€‚

```java
@Component
@Qualifier("cold")
public class IceCream implements Dessert {

    public void play() {
        System.out.println("è¿™æ˜¯ IceCream");
    }
}

```

è¿™æ ·åœ¨è£…é…beançš„æ—¶å€™å°±éœ€è¦å¼•ç”¨`cold`é™å®šç¬¦äº† ï¼š

```java
@Autowired
@Qualifier(value = "cold")
public void setDessert(Dessert dessert){
	this.dessert = dessert;
}
```

å½“é€šè¿‡Javaæ˜¾ç¤ºé…ç½®å®šä¹‰beançš„æ—¶å€™ï¼Œ`@Qualifier`ä¹Ÿå¯ä»¥ä¸`@Bean`æ³¨è§£ä¸€èµ·ä½¿ç”¨ï¼š

```java
@Configuration
public class SpringConfig{
		@Bean
		@Qualifier("cold")
		public Dessert dessert(){
			return new Dessert();
		}
}
```

å½“ç¨‹åºå‘˜è‡ªå®šä¹‰`@Qualifier`å€¼æ—¶ï¼Œæœ€ä½³å®è·µæ˜¯ä¸ºbeané€‰æ‹©ç‰¹å¾æ€§æˆ–è€…æè¿°æ€§çš„æœ¯è¯­ã€‚åœ¨`IceCream`ä¸­ï¼Œæˆ‘ä»¬å°†`Qualifier`è‡ªå®šä¹‰ä¸º`cold`ï¼Œå‡è®¾å¦å¤–ä¸€ä¸ª`Dessert`çš„å®ç°ç±»ä¹Ÿæ˜¯`cold`çš„è¯ ï¼š

```java
@Component
@Qualifier(value = "cold")
public class Popsicle implements Dessert {
    public void play() {
        System.out.println("è¿™æ˜¯ æ°´æœå†°æ£’");
    }
}
```

ç¨‹åºå†æ¬¡å‡ºç°äº†æ­§ä¹‰æ€§çš„é—®é¢˜ ã€‚

Java8å…è®¸å‡ºç°é‡å¤çš„æ³¨è§£ï¼Œåªè¦è¿™ä¸ªæ³¨è§£æœ¬èº«åœ¨å®šä¹‰çš„æ—¶å€™å¸¦æœ‰ `@Repeatable` æ³¨è§£å°±å¯ä»¥ã€‚ä¸è¿‡ï¼ŒSpringçš„`@Qualifier`æ³¨è§£å¹¶æ²¡æœ‰åœ¨å®šä¹‰æ—¶æ·»åŠ `@Repeatable`æ³¨è§£ã€‚æ‰€ä»¥ï¼Œä¸‹é¢è¿™ç§ä½¿ç”¨æ–¹æ³•æ˜¯é”™è¯¯çš„ï¼š

```java
@Autowired
@Qualifier("cold")
@Qualifier("creamy")
public void setDessert(Dessert dessert){
  this.dessert = dessert;
}
```

é‚£ä¹ˆï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•åŒºåˆ†`IceCream`å’Œ`Popsicle`ç±»å‘¢ ï¼Ÿ

#### åˆ›å»ºè‡ªå®šä¹‰çš„é™å®šç¬¦æ³¨è§£

æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ³¨è§£ï¼Œå®ƒæœ¬èº«ä½¿ç”¨`@Qualifier`æ³¨è§£æ¥æ ‡æ³¨ã€‚

```java
@Target({ElementType.TYPE,ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Qualifier
public @interface Cold {
    // ...
}

@Target({ElementType.TYPE,ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Qualifier
public @interface Creamy {
    // ...
}

@Target({ElementType.METHOD,ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Qualifier
public @interface Fruit {
    // ...
}

```

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°çœ‹ä¸‹ `IceCream` ï¼Œå¹¶ä¸ºå…¶æ·»åŠ ä»¥ä¸‹æ³¨è§£ï¼š

```java
@Component
@Cold
@Creamy
public class IceCream implements Dessert {
    // ...
}
// ...
@Component
@Cold
@Fruit
public class Popsicle implements Dessert {
    // ...
}
```

æœ€ç»ˆï¼Œåœ¨æ³¨å…¥ç‚¹ï¼Œæˆ‘ä»¬ä½¿ç”¨å¿…è¦çš„é™å®šç¬¦æ³¨è§£è¿›è¡Œä»»æ„ç»„åˆï¼Œä»è€Œå°†å¯é€‰èŒƒå›´ç¼©å°åˆ°åªæœ‰ä¸€ä¸ªbeanæ»¡è¶³éœ€æ±‚ ã€‚

```java
@Autowired
@Cold
@Fruit
public void setDessert(Dessert dessert){
    this.dessert = dessert;
}
```

ä¸ºäº†åˆ›å»ºè‡ªå®šä¹‰çš„æ¡ä»¶åŒ–æ³¨è§£ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„æ³¨è§£å¹¶åœ¨è¿™ä¸ªæ³¨è§£ä¸Šæ·»åŠ äº†`@Conditional` ã€‚ä¸ºäº†åˆ›å»ºè‡ªå®šä¹‰çš„é™å®šç¬¦æ³¨è§£ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æ³¨è§£å¹¶åœ¨è¿™ä¸ªæ³¨è§£ä¸ŠåŠ ä¸Š `@Qualifier`

## åˆ›å»ºè‡ªå®šä¹‰æ¡ä»¶åŒ–æ³¨è§£

> è‡ªå®šä¹‰@Conditionalæ³¨è§£ç¤ºä¾‹

ConditionalOnMyProperties.class

```java
@Retention(RetentionPolicy.RUNTIME)
@Conditional(OnMyPropertiesCondition.class)
public @interface ConditionalOnMyProperties {
    String name();
}
```

OnMyPropertiesCondition.class

```java
public class OnMyPropertiesCondition implements Condition {
    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        // æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒå˜é‡æ˜¯å¦åŒ…å«æ³¨è§£ä¸­çš„å±æ€§
        Map<String,Object> annotationAttributes = metadata.getAnnotationAttributes(ConditionalOnMyProperties.class.getName());
        if(annotationAttributes != null && annotationAttributes.containsKey("name")){
            return context.getEnvironment().containsProperty(annotationAttributes.get("name").toString());
        }
        return false;
    }
}
```

HelloWorld.class

```java
public class HelloWorld {
    public void print() {
        System.out.println("hello world");
    }
}
```

ConditionClass.class

```java
@Configuration
@ConditionalOnMyProperties(name = "message")
public class ConditionClass {
    @Bean
    public HelloWorld helloWorld(){
        return new HelloWorld();
    }
}
```

```java
public static void main(String[] args) {
        System.setProperty("message","something");
        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(ConditionClass.class);
        try {
            context.getBean("helloWorld",HelloWorld.class).print();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
```

## beançš„ä½œç”¨åŸŸ

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpringåº”ç”¨ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰beanéƒ½æ˜¯ä½œä¸ºä»¥**å•ä¾‹ï¼ˆsingletonï¼‰**çš„å½¢å¼åˆ›å»ºçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡ç»™å®šçš„ä¸€ä¸ªbeanè¢«æ³¨å…¥åˆ°å…¶ä»–beanå¤šå°‘æ¬¡ï¼Œæ¯æ¬¡æ‰€æ³¨å…¥çš„éƒ½æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚

Springå®šä¹‰äº†å¤šç§ä½œç”¨åŸŸï¼Œå¯ä»¥åŸºäºè¿™äº›ä½œç”¨åŸŸåˆ›å»ºbean

- å•ä¾‹ï¼ˆSingletonï¼‰ï¼šåœ¨æ•´ä¸ªåº”ç”¨ä¸­ï¼Œåªåˆ›å»ºbeançš„ä¸€ä¸ªå®ä¾‹ã€‚
- åŸå‹ï¼ˆPrototypeï¼‰ï¼šæ¯æ¬¡æ³¨å…¥æˆ–è€…é€šè¿‡Springåº”ç”¨ä¸Šä¸‹æ–‡è·å–çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„beanå®ä¾‹ã€‚
- ä¼šè¯ï¼ˆSessionï¼‰ï¼šåœ¨Webåº”ç”¨ä¸­ï¼Œä¸ºæ¯ä¸ªä¼šè¯åˆ›å»ºä¸€ä¸ªbeanå®ä¾‹ã€‚
- è¯·æ±‚ï¼ˆRequestï¼‰ï¼šåœ¨Webåº”ç”¨ä¸­ï¼Œä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªbeanå®ä¾‹ã€‚

å•ä¾‹æ˜¯é»˜è®¤çš„ä½œç”¨åŸŸï¼Œä½†å¯¹äºæ˜“å˜ï¼ˆmutableï¼‰çš„ç±»å‹æ¥è¯´ï¼Œè¿™ç§ä½œç”¨åŸŸå¹¶ä¸åˆé€‚ï¼Œ**å¦‚æœé€‰æ‹©å…¶ä»–çš„ä½œç”¨åŸŸï¼Œè¦ä½¿ç”¨`@Scope`æ³¨è§£**ï¼Œä»–å¯ä»¥å’Œ`@Component`æˆ–è€…`@Bean`ä¸€èµ·ä½¿ç”¨ã€‚

ä¾‹å¦‚ï¼š

å¦‚æœä½ ä½¿ç”¨ç»„ä»¶æ‰«ææ¥å‘ç°beanï¼Œé‚£ä¹ˆä½ å¯ä»¥åœ¨beançš„ç±»ä¸Šä½¿ç”¨ `@Scope` æ³¨è§£ï¼Œå°†å…¶å£°æ˜ä¸ºåŸå‹bean ã€‚

```java
@Component
@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
public class NotePad{
    // ...
}
```

è¿™é‡Œä½¿ç”¨`ConfigurableBeanFactory`ç±»çš„`SCOPE_PROTOTYPE`å¸¸é‡è®¾ç½®äº†åŸå‹ä½œç”¨åŸŸã€‚

> ConfigurableBeanFactory.java

```java
public interface ConfigurableBeanFactory extends HierarchicalBeanFactory, SingletonBeanRegistry {
    String SCOPE_SINGLETON = "singleton";
    String SCOPE_PROTOTYPE = "prototype";
    // .,,
}
```

å¦‚æœä½ æƒ³åœ¨Javaé…ç½®ï¼ˆæ˜¾ç¤ºé…ç½®ï¼‰ä¸­å°†Notepadå£°æ˜ä¸ºåŸå‹beanï¼Œé‚£ä¹ˆå¯ä»¥ç»„åˆä½¿ç”¨ `@Scope` å’Œ `@Bean` æ¥æŒ‡å®šæ‰€éœ€è¦çš„ä½œç”¨åŸŸã€‚

```java
@Bean
@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
public Notepad notepad(){
    return new Notepad();
}
```

ä½ è¿˜å¯ä»¥åœ¨XMLä¸­è®¾ç½®ä½œç”¨åŸŸï¼š

```xml
<bean id="notepad" class="com.java.notepad" scope="prototype"/>
```

### ä½¿ç”¨ä¼šè¯å’Œè¯·æ±‚ä½œç”¨åŸŸ

åœ¨Webåº”ç”¨ä¸­ï¼Œå¦‚æœèƒ½å¤Ÿå®ä¾‹åŒ–åœ¨ä¼šè¯å’Œè¯·æ±‚èŒƒå›´å†…å…±äº«çš„beanï¼Œé‚£å°†æ˜¯éå¸¸æœ‰ä»·å€¼çš„äº‹æƒ…ã€‚å°±è´­ç‰©è½¦beanæ¥è¯´ï¼Œæ¯ä¸€ä¸ªç”¨æˆ·éƒ½éœ€è¦æœ‰ä¸åŒçš„è´­ç‰©è½¦ï¼Œæ‰€ä»¥ä¼šè¯ä½œç”¨åŸŸæ˜¯æœ€ä¸ºåˆé€‚çš„ï¼Œå› ä¸ºå®ƒä¸ç»™å®šçš„ç”¨æˆ·å…³è”æ€§æœ€å¤§ã€‚

è¦æŒ‡å®šä¼šè¯ä½œç”¨åŸŸï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`@Scope`æ³¨è§£ï¼š

```java
@Component
@Scope(value= WebApplicationContext.SCOPE_SESSION,
      proxyMode = ScopedProxyMode.INTERFACES)
)
// å½“ShoppingCartæ˜¯ä¸€ä¸ªæ¥å£æ—¶
public ShoppingCart cart(){
  // ...
}
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†valueè®¾ç½®ä¸ºäº†`WebApplicationContext`ä¸­çš„`SCOPE_SESSION`å¸¸é‡ï¼Œè¿™è¡¨æ˜Springä¸ºwebåº”ç”¨ä¸­çš„æ¯ä¸ªä¼šè¯åˆ›å»ºä¸€ä¸ªå®ä¾‹ã€‚

> WebApplicationContext.java

```java
public interface WebApplicationContext extends ApplicationContext {
	String SCOPE_REQUEST = "request";
    String SCOPE_SESSION = "session";
	// ...
}
```

è¦æ³¨æ„çš„æ˜¯ï¼Œ`@Scope`è¿˜æœ‰ä¸€ä¸ª`proxyMode`å±æ€§ï¼Œå®ƒè¢«è®¾ç½®ä¸ºäº†`ScopedProxyMode.INTERFACES`ã€‚**è¿™ä¸ªå±æ€§è§£å†³äº†å°†ä¼šè¯æˆ–è€…è¯·æ±‚ä½œç”¨åŸŸçš„beanæ³¨å…¥åˆ°å•ä¾‹beanä¸­æ‰€é‡åˆ°çš„é—®é¢˜** ï¼š

å‡è®¾æˆ‘ä»¬éœ€è¦å°†`ShoppingCart`çš„beanæ³¨å…¥åˆ°å•ä¾‹`StoreService`beançš„setteræ–¹æ³•ä¸­ï¼š

```java
@Component
public class StoreService{

  @Autowired
  public void setShoppingCart(ShoppingCart shoppingCart){
    this.shoppingCart = shoppingCart;
  }

}
```

å› ä¸º`StoreService`æ˜¯ä¸€ä¸ªå•ä¾‹çš„beanï¼Œä¼šåœ¨Springåº”ç”¨ä¸Šä¸‹æ–‡åŠ è½½çš„æ—¶å€™åˆ›å»ºã€‚å½“å®ƒåˆ›å»ºçš„æ—¶å€™ï¼ŒSpringä¼šè¯•å›¾å°†`ShoppingCart`beanæ³¨å…¥åˆ°`setShoppingCart()`æ–¹æ³•ä¸­ã€‚ä½†æ˜¯`ShoppingCart`bean æ˜¯ä¼šè¯ä½œç”¨åŸŸçš„ï¼Œæ­¤æ—¶å¹¶ä¸å­˜åœ¨ã€‚ç›´åˆ°æŸä¸ªç”¨æˆ·è¿›å…¥äº†ç³»ç»Ÿï¼Œåˆ›å»ºäº†ä¼šè¯ä¹‹åï¼Œæ‰ä¼šå‡ºç°`ShoppingCart`çš„å®ä¾‹ã€‚

å¦å¤–ï¼Œç³»ç»Ÿä¸­å°†ä¼šå‡ºç°å¤šä¸ª`ShoppingCart`å®ä¾‹ï¼šæ¯ä¸ªç”¨æˆ·ä¸€ä¸ªã€‚æˆ‘ä»¬å¹¶ä¸å¸Œæœ›å°†ç‰¹å®šçš„`ShoppingCart`æ³¨å…¥åˆ°`StoreService`ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯å½“`StoreService`å¤„ç†è´­ç‰©è½¦åŠŸèƒ½æ—¶ï¼Œå®ƒæ‰€ä½¿ç”¨çš„`ShoppingCart`æ°æ°æ˜¯å½“å‰ä¼šè¯æ‰€å¯¹åº”çš„é‚£ä¸ªã€‚

Springå¹¶ä¸ä¼šå°†å®é™…çš„`ShoppingCart`beanæ³¨å…¥åˆ°`StoreService`ä¸­ï¼ŒSpringä¼šæ³¨å…¥ä¸€ä¸ªåˆ°`ShoppingCart`beançš„ä»£ç†ï¼š

![ä½œç”¨åŸŸä»£ç†èƒ½å¤Ÿå»¶è¿Ÿæ³¨å…¥è¯·æ±‚å’Œä¼šè¯ä½œç”¨åŸŸçš„bean](https://raw.githubusercontent.com/zhangzhaolin/spring-demo/master/%E5%9B%BE%E7%89%87/%E7%AC%AC%E4%B8%89%E7%AB%A0/%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%BB%A3%E7%90%86%E8%83%BD%E5%A4%9F%E5%BB%B6%E8%BF%9F%E6%B3%A8%E5%85%A5%E8%AF%B7%E6%B1%82%E5%92%8C%E4%BC%9A%E8%AF%9D%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84bean.png)

è¿™ä¸ªä»£ç†ä¼šæš´éœ²ä¸`ShoppingCart`ç›¸åŒçš„æ–¹æ³•ï¼Œæ‰€ä»¥`StoreService`ä¼šè®¤ä¸ºå®ƒå°±æ˜¯ä¸€ä¸ªè´­ç‰©è½¦ã€‚ä½†æ˜¯ï¼Œå½“`StoreService`è°ƒç”¨è´­ç‰©è½¦æ–¹æ³•æ—¶ï¼Œä»£ç†ä¼šå¯¹å…¶è¿›è¡Œ**æ‡’è§£æå¹¶å°†è°ƒç”¨å§”æ‰˜ç»™**ä¼šè¯ä½œç”¨åŸŸå†…çœŸæ­£çš„`ShoppingCart`bean ã€‚

å¦‚é…ç½®æ‰€ç¤ºï¼Œ`proxyMode`è¢«è®¾ç½®æˆä¸ºäº†`ScopedProxyMode.INTERFACES`ï¼Œè¿™è¡¨æ˜è¿™ä¸ªä»£ç†è¦å®ç°`ShoppingCart`æ¥å£ï¼Œå¹¶å°†è°ƒç”¨å§”æ‰˜ç»™å®ç°beanã€‚

**å¦‚æœ`ShoppingCart`æ˜¯ä¸€ä¸ªæ¥å£è€Œä¸æ˜¯ä¸€ä¸ªç±»ï¼Œè¿™æ˜¯å¯ä»¥çš„ã€‚**ä½†æ˜¯å¦‚æœ`ShoppingCart`æ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»ï¼ŒSpringå°±æ²¡æœ‰åŠæ³•åˆ›å»ºåŸºäºæ¥å£çš„ä»£ç†äº†ã€‚æ­¤æ—¶ï¼Œå®ƒå¿…é¡»ä½¿ç”¨CGLibæ¥ç”ŸæˆåŸºäºç±»çš„ä»£ç†ã€‚æ‰€ä»¥ï¼Œå¦‚æœbeanç±»å‹æ˜¯å…·ä½“çš„ç±»çš„è¯ï¼Œæˆ‘ä»¬å¿…é¡»è¦å°†`proxyMode`å±æ€§è®¾ç½®ä¸º`ScopedProxyMode.TARGET_CLASS`

è¯·æ±‚ä½œç”¨åŸŸå’Œä¼šè¯ä½œç”¨åŸŸä¸€æ ·ï¼Œä¹Ÿéœ€è¦ä»¥ä½œç”¨åŸŸçš„æ–¹å¼è¿›è¡Œæ³¨å…¥ã€‚

### åœ¨XMLä¸­ä½¿ç”¨ä½œç”¨åŸŸä»£ç†

```xml
 <bean id="shoppingCart" class="demo.test.ShoppingCart" scope="session">
        <!-- shoppingCartæ˜¯æ¥å£çš„æ—¶å€™ -->
        <aop:scoped-proxy proxy-target-class="false"/>
    </bean>
</beans>
```

`<bean>`ä¸­çš„scopeå±æ€§èƒ½å¤Ÿè®¾ç½®beançš„ä½œç”¨åŸŸï¼Œ`<aop:scoped-proxy>`æ˜¯å’Œ`@Scope`æ³¨è§£ä¸­çš„`proxyMode`å±æ€§åŠŸèƒ½ç›¸åŒçš„Spring XMLé…ç½®å…ƒç´ ã€‚å®ƒä¼šå‘Šè¯‰Springä¸ºbeanåˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸä»£ç†ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼šä½¿ç”¨CGLibåˆ›å»ºç›®æ ‡ç±»çš„ä»£ç†ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†`proxy-target-class`å±æ€§è®¾ç½®ä¸ºfalseï¼Œè¿›è€Œå‘Šè¯‰å®ƒç”ŸæˆåŸºäºæ¥å£çš„ä»£ç†ã€‚

## è¿è¡Œæ—¶å€¼æ³¨å…¥

åœ¨è®¨è®ºä¾èµ–æ³¨å…¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šå¸¸æ‰€è®¨è®ºçš„æ˜¯å°†ä¸€ä¸ªbeanå¼•ç”¨æ³¨å…¥åˆ°å¦ä¸€ä¸ªbeançš„å±æ€§æˆ–è€…æ„é€ å™¨å‚æ•°ä¸­ã€‚å®ƒé€šå¸¸æ¥è®²æ˜¯å°†ä¸€ä¸ªå¯¹è±¡ä¸å¦ä¸€ä¸ªå¯¹è±¡è¿›è¡Œå…³è”ã€‚

ç„¶è€Œè¿˜æœ‰å¦ä¸€ä¸ªæ–¹é¢æ˜¯å°†ä¸€ä¸ªå€¼æ³¨å…¥åˆ°beançš„å±æ€§æˆ–è€…æ„é€ å™¨ä¸­ã€‚

ä¾‹å¦‚ï¼šæˆ‘ä»¬å°†ä¸“è¾‘çš„åå­—è£…é…åˆ°`BlanckDisc`bean çš„æ„é€ å™¨æˆ–è€…titleå±æ€§ä¸­:

> BlankDisc.class

```java
public class BlankDisc implements CompactDisc {

    private String title;
    private String artist;

    public BlankDisc(String title, String artist) {
        this.title = title;
        this.artist = artist;
    }

    @Override
    public void play() {
        System.out.print("Playing " + title + " by " + artist);
    }
}
```

ä½¿ç”¨XMLè£…é…:

````xml
<bean id="blankDisc" class="soundsystem.compactdisc.BlankDisc">
		<constructor-arg value="Sgt. Pepper's Lonely Hearts Club Band"/>
		<constructor-arg value="The Beatles"/>
</bean>
````

æˆ‘ä»¬è¿˜å¯èƒ½ä½¿ç”¨Javaçš„æ–¹å¼è¿›è¡Œè£…é…ï¼š

```java
@Bean
public CompactDisc sgtPeppers(){
  return new BlankDisc("Sgt. Pepper's Lonely Hearts Club Band","The Beatles");
}
```

ä½†æ˜¯ï¼Œä»¥ä¸Šä¸¤ç§æ–¹å¼éƒ½æ˜¯å°†å€¼ä»¥å›ºå®šç¼–ç çš„å½¢å¼æ³¨å…¥åˆ°beanä¸­çš„ã€‚Springæä¾›äº†ä¸¤ç§æ–¹å¼è®©è¿™äº›å€¼åœ¨è¿è¡Œæ—¶æ³¨å…¥ï¼š

- å±æ€§å ä½ç¬¦
- Springè¡¨è¾¾å¼è¯­è¨€

### æ³¨å…¥å¤–éƒ¨çš„å€¼

åœ¨Springä¸­ï¼Œè·å–å¤–éƒ¨å€¼æœ€ç®€å•çš„æ–¹å¼æ˜¯å£°æ˜æ•°æ®æºå¹¶é€šè¿‡Springçš„`Enviroment`æ¥è·å–å±æ€§å€¼ ï¼š

```java
@Configuraion
@PropertyResource(value="classpath:/app.properties")
public class ExpressiveConfig{
    @Autowired
    private Enviroment enviroment;
    @Autowired
    private BlankDisc disc(){
        return new BlankDisc(enviroment.getProperty("disc.title"),
                            enviroment.getProperty("disc.artist")
        );
    }
}
```

> app.properties

```java
disc.title = å¯»å®æ¸¸æˆ
disc.artist = vae
```

> BlankDisc.java

```java
public interface CompactDisc {
    void play();
}
// ...
public class BlankDisc implements CompactDisc{
    private String title;
    private String artist;

    public BlankDisc(String title , String artist) {
        this.title = title;
        this.artist = artist;
    }

    public void play() {
        System.out.println("title : " + title + " artist : " + artist);
    }
} 
```

åœ¨`Enviroment`ç±»ä¸­è¿˜æœ‰å…¶ä»–ä¸€ç³»åˆ—çš„æ–¹æ³•ï¼Œå…¶ä¸­åŒ…æ‹¬`getProperty()`æ–¹æ³•çš„é‡è½½ä»¥åŠå…¶ä»–æ–¹æ³• ï¼š

```java
public interface PropertyResolver {
    // æ£€æŸ¥æŸä¸ªå±æ€§æ˜¯å¦å­˜åœ¨
    boolean containsProperty(String key);

    String getProperty(String key);
	// å½“æŒ‡å®šå±æ€§var1ä¸å­˜åœ¨æ—¶å€™ï¼Œè¿”å›é»˜è®¤å€¼ defaultValue
    String getProperty(String key, String defaultValue);

    @Nullable
    // è¿”å›éå­—ç¬¦ä¸²ç±»å‹T
    <T> T getProperty(String key, Class<T> targetType);
	// å½“æŒ‡å®šå±æ€§var1ä¸å­˜åœ¨æ—¶å€™ï¼Œè¿”å›æŒ‡å®šç±»å‹T defaultValue
    <T> T getProperty(String key, Class<T> targetType, T defaultValue);
	// å½“æŒ‡å®šå±æ€§ä¸å­˜åœ¨æ—¶å€™æŠ¥é”™
    String getRequiredProperty(String key) throws IllegalStateException;

    <T> T getRequiredProperty(String key, Class<T> targetType) throws IllegalStateException;

    String resolvePlaceholders(String text);

    String resolveRequiredPlaceholders(String text) throws IllegalArgumentException;
}
```

é™¤äº†å±æ€§ç›¸å…³åŠŸèƒ½ä¹‹å¤–ï¼Œ`Enviroment`å¯¹è±¡è¿˜æä¾›äº†ä¸€äº›æ–¹æ³•æ¥æ£€æŸ¥å“ªäº›`profile`å¤„äºæ¿€æ´»çŠ¶æ€ ï¼š

```java
public interface Environment extends PropertyResolver {
    // è·å–åˆ°profileä¸ºactiveçš„æ•°ç»„
    String[] getActiveProfiles();
	// è·å–åˆ°profileä¸ºdefaultçš„æ•°ç»„
    String[] getDefaultProfiles();
	// å¦‚æœenvironmentæ”¯æŒç»™å®šçš„profile å°±è¿”å›true
    boolean acceptsProfiles(String... var1);
}
```

### è§£æå±æ€§å ä½ç¬¦

#### ä½¿ç”¨XMLæ–¹å¼

```xml
<bean id="blankDisc" class="com.springdemo.soundsystem.BlankDisc" c:_0="${disc.title}" c:_1="${disc.artist}"/>
<context:property-placeholder location="classpath:/app.properties"/>
```

#### ä½¿ç”¨Javaé…ç½®æ–¹å¼

```java
@Configuration
@ComponentScan(basePackages = "com.springdemo")
@PropertySource(value = "classpath:/app.properties")
public class ExpressiveConfig {
    @Bean
    public static PropertySourcesPlaceholderConfigurer placeholderConfigurer(){
        return new PropertySourcesPlaceholderConfigurer();
    }
}
```

```java
@Component
public class BlankDisc implements CompactDisc {
	// ...	
    public BlankDisc(
            @Value("${disc.title}") String title ,
            @Value("${disc.artist}") String artist) {
        this.title = title;
        this.artist = artist;
    }
}
```

## å‚ç…§

1. [è¯¦è§£Springä¸­çš„Profile](https://www.jianshu.com/p/948c303b2253)

## æ€»ç»“

åœ¨è¿™ç« ä¸­æˆ‘ä»¬ä¸»è¦å­¦ä¹ äº†ä»¥ä¸‹å†…å®¹ ï¼š 

- `@Profile`æ³¨è§£ ï¼š ä¸»è¦ç”¨æ¥åŒºåˆ«ä¸åŒå¼€å‘æˆ–è€…è¿è¡Œç¯å¢ƒé—®é¢˜ï¼Œä¾‹å¦‚æ˜¯mysqlè¿˜æ˜¯oracleæ•°æ®åº“ç­‰ç­‰
- æ¿€æ´»`profile`çš„å‡ ç§æ–¹æ³• ï¼š ä½œä¸ºWEBåº”ç”¨ä¸Šä¸‹æ–‡ã€ä½œä¸ºJNDIæ¡ç›®ã€ä½œä¸ºç¯å¢ƒå˜é‡ã€ä½œä¸ºJVMç³»ç»Ÿå±æ€§ã€åœ¨é›†æˆæµ‹è¯•ä¸­ä½¿ç”¨`@ActiveProfiles`æ³¨è§£è®¾ç½®
- `@Conditional`æ³¨è§£ ï¼š`@Profile`çš„â€œå‡çº§ç‰ˆâ€ï¼Œè®¾ç½®æ¡ä»¶åŒ–çš„Beanï¼Œ`@Conditional`æ³¨è§£ä¸­çš„ç±»å¿…é¡»è¦å®ç°`Conditional`æ¥å£ä¸­çš„`matches()`æ–¹æ³•
- `@Primary`æ³¨è§£ ï¼š æ ‡ç¤ºé¦–é€‰çš„beanï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼‰
- `@Qualifier`æ³¨è§£ ï¼š æ¶ˆé™¤è£…é…æ—¶çš„æ­§ä¹‰æ€§ ã€‚ä¹Ÿå¯ä»¥é€šè¿‡`@Qualifier`è‡ªå®šä¹‰é™å®šç¬¦æ³¨è§£ ã€‚
- `bean`çš„å››ç§ä½œç”¨åŸŸ ï¼šå•ä¾‹ã€åŸå‹ ã€ä¼šè¯ ã€è¯·æ±‚
- `@Scope`æ³¨è§£ä¿®æ”¹beançš„ä½œç”¨åŸŸ ï¼š`@Scope(ConfigurationBeanFactory.SCOPE_PROTOTYPE)`ï¼Œå¦‚æœæ˜¯ä¼šè¯/è¯·æ±‚ä½œç”¨åŸŸçš„è¯ï¼Œé™¤äº†è®¾ç½®`@Scope(value = WebApplicationContext.SCOPE_SESSION)`ä¹‹å¤–ï¼Œè¿˜éœ€è¦è®¾ç½®`proxyMode=ScopedProxyMode.INTERFACE`æˆ–è€…`proxyMode=ScopedProxyMode.TARGET_CLASS`

![](https://raw.githubusercontent.com/zhangzhaolin/GraphBed/master/2019/09/20190918153441.png)