[TOC]

# Spring MVCé…ç½®çš„æ›¿ä»£æ–¹æ¡ˆ

## è‡ªå®šä¹‰`DispatcherServlet`é…ç½®

```java
public class WebApplicationInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {

    protected Class<?>[] getRootConfigClasses() {
        return new Class[]{RootConfig.class};
    }

    protected Class<?>[] getServletConfigClasses() {
        return new Class[]{WebConfig.class};
    }

    protected String[] getServletMappings() {
        return new String[]{"/"};
    }

}
```

åœ¨`AbstracAnnotationConfigDispatcherInitializer`**å°†`DispatcherServlet`æ³¨å†Œåˆ°`servlet`å®¹å™¨ä¹‹å**ï¼Œå°±**ä¼šè°ƒç”¨`customizeRegistration()`**ï¼Œ**å¹¶å°†`servlet`æ³¨å†Œåå¾—åˆ°çš„`Registration.Dynamic`ä¼ é€’è¿›æ¥**ã€‚é€šè¿‡é‡è½½`customizeRegistration()`æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹`DispatcherServlet`è¿›è¡Œé¢å¤–çš„é…ç½® ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†`multipart`è¯·æ±‚å’Œæ–‡ä»¶ä¸Šä¼  ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥é‡è½½`customizeRegistration()`æ–¹æ³•æ¥è®¾ç½®`MultipartConfigElement`

```java
@Overirde
protected void customizeRegistration(ServletRegistration.Dynamic registration){
    registration.setMultipartConfig(new MultipartConfigElement("/tmp/spittr/uploads"));
}
```

é™¤äº†è®¾ç½®`multipart`å¤–ï¼Œè¿˜å¯ä»¥è¿›è¡Œä»¥ä¸‹é…ç½®ï¼š

```java
public interface Dynamic extends ServletRegistration, javax.servlet.Registration.Dynamic {
    // è®¾ç½®load-on-startupä¼˜å…ˆçº§
	public void setLoadOnStartup(int loadOnStartup);
	public Set<String> setServletSecurity(ServletSecurityElement constraint);
	// é…ç½®Servlet3.0å¯¹multipartçš„æ”¯æŒ
    public void setMultipartConfig(MultipartConfigElement multipartConfig);
	public void setRunAsRole(String roleName);
    // è®¾ç½®åˆå§‹åŒ–å‚æ•°
    public boolean setInitParameter(String name, String value);
}
```

## æ·»åŠ å…¶ä»–çš„`Servlet`å’Œ`Filter`

æŒ‰ç…§`AbstractAnnotationConfigDispatcherServletInitializer`å®šä¹‰ï¼Œå®ƒä¼šåˆ›å»º`DispatcherServlet`å’Œ`ContextLoaderListener`ã€‚

å¦‚æœæƒ³è¦æ³¨å†Œå…¶ä»–çš„`Servlet`ã€`Filter`æˆ–è€…`Listener`çš„è¯ï¼Œæœ€ç®€å•çš„ä¸€ä¸ªæ–¹æ³•æ˜¯å®ç°`WebApplicationInitializer`æ¥å£ã€‚

```java
public class MyServletInitializer implements WebApplicationInitializer {
    public void onStartup(ServletContext servletContext) throws ServletException {
        // æ³¨å†Œservlet
        ServletRegistration.Dynamic myServlet = servletContext.addServlet("myServlet",MyServlet.class);
        // æ˜ å°„servlet
        myServlet.addMapping("/custom/**");
    }
}
```

ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ›å»ºæ–°çš„`WebApplicationInitializer`å®ç°æ¥æ³¨å†Œ`Listener`å’Œ`Filter` ï¼š

```java
public class MyFilterInitalizer implements WebApplicationInitializer {
    @Override
    public void onStartup(ServletContext servletContext) throws ServletException {
        servletContext.addFilter("myFilter", MyFilter.class)
                .addMappingForUrlPatterns(null, false, "/custom/**");
    }
}    
```

ä¸è¿‡ï¼Œå¦‚æœä½ åªæ˜¯æ³¨å†Œ`Filter`å¹¶å°†å…¶æ˜ å°„åˆ°`DispatcherServlet`ä¸Šçš„è¯ï¼Œè¿˜æœ‰ä¸€ç§å¿«æ·æ–¹å¼ï¼Œåœ¨`AbstractAnnotationConfigDispatcherServletInitializer`å®ç°ç±»ä¸­é‡è½½`getServletFilters()`æ–¹æ³•ï¼š

```java
@Override
protected Filter[] getServletFilters() {
	return new Filter[]{MyFilter.class};
}
```

`getServletFilters`æ–¹æ³•è¿”å›çš„æ‰€æœ‰Filteréƒ½ä¼šæ˜ å°„åˆ°`DispatcherServlet`ä¸Šã€‚

# å¤„ç†`multipart`å½¢å¼çš„æ•°æ®

`multipart`æ ¼å¼çš„æ•°æ®ä¼šå°†ä¸€ä¸ªè¡¨å•æ‹†åˆ†æˆä¸ºå¤šä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†å¯¹åº”ä¸€ä¸ªè¾“å…¥åŸŸã€‚

## é…ç½®`multipart`è§£æå™¨

- å¦‚æœé‡‡ç”¨`Servlet`åˆå§‹åŒ–ç±»æ¥é…ç½®`DispatcherServlet`çš„è¯ï¼Œè¿™ä¸ªåˆå§‹åŒ–ç±»å®ç°äº†`WebApplicationInitializer` ï¼š

```java
public class MyServletInitializer implements WebApplicationInitializer{
    public void onStartup(ServletContext servletContext) throws ServletException {
        ServletRegistration.Dynamic myServlet = servletContext.addServlet("myServlet",MyServlet.class);
        myServlet.setMultipartConfig(
                new MultipartConfigElement("/tmp/spittr/uploads",
                        2*1024,4*1024,0));
        myServlet.addMapping("/custom/**");
    }
}
```

- å¦‚æœç»§æ‰¿äº†`AbstractAnnotationConfigDispatcherServletInitializer` ï¼š

```java
@Override
 protected void customizeRegistration(ServletRegistration.Dynamic registration) {
	registration.setMultipartConfig(
	new MultipartConfigElement("/tmp/spittr/uploads",
                        2*1024,4*1024,0));
}
```

## å¤„ç†`multipart`è¯·æ±‚

ä¸ºåœ¨æ§åˆ¶å™¨ä¸Šæ¥æ”¶ä¸Šä¼ çš„æ–‡ä»¶ï¼Œæœ€å¸¸è§çš„æ–¹å¼å°±æ˜¯ï¼Œ**åœ¨æ§åˆ¶å™¨æ–¹æ³•å‚æ•°ä¸Šæ·»åŠ `@RequestPart`æ³¨è§£**ã€‚

```java
@PostMapping(value="/register")
public String register(@RequestPart("profilePicture") byte[] picture
					  ,@Valid Spitter spitter,Errors errors){
    // ....
}
```

`<form>`æ ‡ç­¾å°†`enctype`å±æ€§è®¾ç½®ä¸º`multipart/form-data`ï¼Œè¿™ä¼šå‘Šè¯‰æµè§ˆå™¨ä»¥`multipart`æ•°æ®çš„å½¢å¼æäº¤è¡¨å•ã€‚

Springè¿˜æä¾›äº†`MutipartFile`æ¥å£ï¼Œä¸ºå¤„ç†multipartæ•°æ®æä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ã€‚

```java
@PostMapping(value="/register")
public String register(@RequestPart("profilePicture") Multipart picture
					  ,@Valid Spitter spitter,Errors errors){
    // ....
}
```

`MultipartFile`çš„ä»£æ›¿æ–¹æ¡ˆæ˜¯ä½¿ç”¨`javax.servlet.http.Part`

# å¤„ç†å¼‚å¸¸

## ä¹±ç é—®é¢˜

åœ¨ç¼–å†™è¿™éƒ¨åˆ†ä»£ç è¿‡ç¨‹ä¸­ï¼Œä¹±ç é—®é¢˜å›°æ‰°äº†æˆ‘å¾ˆé•¿æ—¶é—´ï¼Œå…·ä½“éœ€è¦ä¸‹é¢ä¸¤ä¸ªé…ç½® ï¼š

```java
public class WebApplicationInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {

    protected Class<?>[] getRootConfigClasses() {
        return new Class[]{RootConfig.class};
    }

    protected Class<?>[] getServletConfigClasses() {
        return new Class[]{WebConfig.class};
    }

    protected String[] getServletMappings() {
        return new String[]{"/"};
    }

    @Override
    protected Filter[] getServletFilters() {
        return new Filter[]{new CharacterEncodingFilter("utf-8",true)};
    }

    @Override
    protected void customizeRegistration(ServletRegistration.Dynamic registration) {
        registration.setMultipartConfig(new MultipartConfigElement(
                "E:/upload",
                4*1024*1024,8*1024*1024,0
        ));
    }
}
```

```java
@Configuration
@EnableWebMvc
@ComponentScan(value = {"controller","errors"})
public class WebConfig implements WebMvcConfigurer {

    @Bean
    public ViewResolver viewResolver(){
        InternalResourceViewResolver resolver = new InternalResourceViewResolver();
        resolver.setPrefix("/views/");
        resolver.setSuffix(".html");
        resolver.setExposeContextBeansAsAttributes(true);
        return resolver;
    }
	// ç¼–ç é—®é¢˜è§£å†³
    @Override
    public void configureMessageConverters(List<HttpMessageConverter<?>> converters) {
        StringHttpMessageConverter converter = new StringHttpMessageConverter(UTF_8);
        // è®°å¾—è¿˜è¦æŠŠjsonè§£æå™¨åŠ ä¸Š...
        converters.add(new MappingJackson2HttpMessageConverter());
        converters.add(converter);
    }

    // é…ç½®é™æ€èµ„æºçš„å¤„ç†
    public void configureDefaultServletHandling(DefaultServletHandlerConfigurer configurer) {
        configurer.enable();
    }

    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/resources/")
                .addResourceLocations("/resources/**");
    }
}
```

åœ¨ä»£ç è¿è¡Œçš„æ—¶å€™ï¼Œæˆ‘å‘ç°ç¼–è¯‘å™¨ideaåˆå‡ºæ¥æ£ä¹±äº†ï¼Œè¿˜éœ€è¦è®¾ç½®ä¸‹è¿™ä¸ªåœ°æ–¹ ï¼š

![](http://zhangzhaolin.oss-cn-beijing.aliyuncs.com/18-8-29/12454940.jpg)

## ç¼–å†™å¼‚å¸¸å¤„ç†çš„æ–¹æ³•

### å°†å¼‚å¸¸æ˜ å°„ä¸ºç‰¹å®šçŠ¶æ€ç 

å¯ä»¥é€šè¿‡`@ResponseStatus`æ³¨è§£å°†å¼‚å¸¸æ˜ å°„ä¸ºHTTPçŠ¶æ€ç ã€‚

```java
@ResponseStatus(value=HttpStatus.NOT_FOUND)
public class SpittleNotFoundException extends RuntimeException {
	// ...
}
```

# ä¸ºæ§åˆ¶å™¨æ·»åŠ é€šçŸ¥

å¦‚æœæ§åˆ¶å™¨ç±»çš„ç‰¹å®šåˆ‡é¢èƒ½å¤Ÿè¿ç”¨åˆ°æ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ‰€æœ‰æ§åˆ¶å™¨ä¸­ï¼Œé‚£ä¹ˆè¿™å°†æ–¹ä¾¿å¾ˆå¤šã€‚ä¾‹å¦‚ï¼Œå¤„ç†å¤šä¸ªæ§åˆ¶å™¨æŠ›å‡ºçš„å¼‚å¸¸ã€‚

**æ§åˆ¶å™¨é€šçŸ¥**æ˜¯ä»»æ„å¸¦æœ‰`@ControllerAdvice`æ³¨è§£çš„ç±»ï¼Œè¿™ä¸ªç±»ä¼šåŒ…å«ä¸€æˆ–å¤šä¸ªå¦‚ä¸‹ç±»å‹çš„æ–¹æ³•ï¼š

- `@ExceptionHandler`æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•
- `InitBinder`æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•
- `ModelAttribute`æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•

ğŸ”° åœ¨å¸¦æœ‰`ControllerAdvice`æ³¨è§£çš„ç±»ä¸­ï¼Œä»¥ä¸Šæ‰€è¿°çš„è¿™äº›æ–¹æ³•ä¼šè¿ç”¨åˆ°æ•´ä¸ªåº”ç”¨ç¨‹åºæ‰€æœ‰æ§åˆ¶å™¨ä¸­å¸¦æœ‰`@RequestMapping`æ³¨è§£çš„æ–¹æ³•ä¸Šã€‚


```java
@ControllerAdvice
public class SpittleExceptionHandler {
    @ExceptionHandler(SpittleNotFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public String spittleNotFoundException(Exception e, Model model) {
        model.addAttribute("message", e.getMessage());
        return "error/not_found";
    }
}
```

# è·¨é‡å®šå‘è¯·æ±‚ä¼ é€’æ•°æ®

## é€šè¿‡URLæ¨¡æ¿è¿›è¡Œé‡å®šå‘

```java
@PostMapping(value="/register")
public String processRegisteration( @Valid Spitter spitter, Errors error, Model model) {
    spitterRepository.save(spitter);
    model.addAttribute("username", spitter.getUserName());
    return "redirect:/spitter/user/{username}";
}
```

ç°åœ¨ï¼Œ`username`ä½œä¸ºå ä½ç¬¦å¡«å……åˆ°äº†URLæ¨¡æ¿ä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥é“¾æ¥åˆ°é‡å®šå‘`String`ä¸­ï¼Œè¿™æ ·ä¼šæ›´åŠ å®‰å…¨ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæ¨¡å‹ä¸­å…¶ä»–åŸå§‹ç±»å‹å€¼éƒ½å¯ä»¥æ·»åŠ åˆ°URLä¸­ä½œä¸ºæŸ¥è¯¢å‚æ•°ï¼š

```java
@PostMapping(value="/register")
public String processRegisteration( @Valid Spitter spitter, Errors error, Model model) {
    spitterRepository.save(spitter);
    model.addAttribute("username", spitter.getUserName());
    model.addAttribute("spitterId",spitter.getId());
    return "redirect:/spitter/user/{username}";
}
```

ç»“æœå€¼ä¸ºï¼š

```java
"/spitter/user/shiwaxinge?spitterId=42"
```

é€šè¿‡è·¯å¾„å˜é‡å’ŒæŸ¥è¯¢å‚æ•°çš„å½¢å¼è·¨é‡å®šå‘ä¼ é€’æ•°æ®ï¼Œæœ‰ä¸€å®šçš„é™åˆ¶ã€‚å®ƒåªèƒ½ç”¨æ¥å‘é€ç®€å•çš„å€¼ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²æˆ–è€…æ•°å€¼ã€‚

## ä½¿ç”¨flashå±æ€§

æŒ‰ç…§å®šä¹‰ï¼Œflashå±æ€§ä¼šä¸€ç›´æºå¸¦è¿™äº›æ•°æ®ç›´åˆ°ä¸‹æ¬¡è¯·æ±‚ï¼Œç„¶åæ‰ä¼šæ¶ˆå¤±ã€‚

`RedirectAttributes`æ˜¯`Model`çš„å­æ¥å£ï¼Œæä¾›äº†`flash`çš„æ‰€æœ‰åŠŸèƒ½ã€‚

```java
@PostMapping(value="/register")
public String processRegisteration( @Valid Spitter spitter, Errors error, RedirectAttributes model) {
    spitterRepository.save(spitter);
    model.addAttribute("username", spitter.getUserName());
    model.addFlashAttribute("spitter",spitter);
    return "redirect:/spitter/user/{username}";
}
```

åœ¨æ‰§è¡Œé‡å®šå‘ä¹‹å‰ï¼Œæ‰€æœ‰çš„flashå±æ€§éƒ½ä¼šå¤åˆ¶åˆ°ä¼šè¯ä¸­ã€‚åœ¨é‡å®šä¹‰ä¹‹åï¼Œå­˜åœ¨ä¼šè¯ä¸­çš„flashå±æ€§ä¼šè¢«å–å‡º

![](https://raw.githubusercontent.com/zhangzhaolin/GraphBed/master/2019/09/20191008151113.png)

